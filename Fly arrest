local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local LocalPlayer = Players.LocalPlayer
local PlayerGui = LocalPlayer:WaitForChild("PlayerGui")

-- GUI Creation
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "SmartFlyFollowGUI"
ScreenGui.ResetOnSpawn = false
ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
ScreenGui.Parent = PlayerGui

-- Main Container Frame (BIGGER SIZE)
local MainFrame = Instance.new("Frame")
MainFrame.Size = UDim2.new(0, 400, 0, 550)
MainFrame.Position = UDim2.new(0.5, -200, 0.5, -275)
MainFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 35)
MainFrame.BorderSizePixel = 0
MainFrame.ClipsDescendants = true
MainFrame.Active = true
MainFrame.Selectable = true
MainFrame.Parent = ScreenGui

-- Title Bar with Drag Functionality
local TitleBar = Instance.new("Frame")
TitleBar.Size = UDim2.new(1, 0, 0, 40)
TitleBar.BackgroundColor3 = Color3.fromRGB(45, 45, 50)
TitleBar.BorderSizePixel = 0
TitleBar.Parent = MainFrame

-- Draggable area in title bar (TOUCH-COMPATIBLE)
local DragArea = Instance.new("TextButton")
DragArea.Size = UDim2.new(1, -80, 1, 0)
DragArea.Position = UDim2.new(0, 0, 0, 0)
DragArea.BackgroundTransparency = 1
DragArea.Text = ""
DragArea.TextTransparency = 1
DragArea.Parent = TitleBar

local TitleText = Instance.new("TextLabel")
TitleText.Size = UDim2.new(1, -80, 1, 0)
TitleText.Position = UDim2.new(0, 15, 0, 0)
TitleText.BackgroundTransparency = 1
TitleText.Text = "SMART FLY FOLLOW"
TitleText.TextColor3 = Color3.fromRGB(220, 220, 220)
TitleText.Font = Enum.Font.GothamBold
TitleText.TextSize = 16
TitleText.TextXAlignment = Enum.TextXAlignment.Left
TitleText.Parent = TitleBar

-- Hide Button
local HideButton = Instance.new("TextButton")
HideButton.Size = UDim2.new(0, 30, 0, 30)
HideButton.Position = UDim2.new(1, -75, 0.5, -15)
HideButton.BackgroundColor3 = Color3.fromRGB(60, 120, 200)
HideButton.BorderSizePixel = 0
HideButton.Text = "—"
HideButton.TextColor3 = Color3.fromRGB(255, 255, 255)
HideButton.Font = Enum.Font.GothamBold
HideButton.TextSize = 16
HideButton.Parent = TitleBar

-- Close Button
local CloseButton = Instance.new("TextButton")
CloseButton.Size = UDim2.new(0, 30, 0, 30)
CloseButton.Position = UDim2.new(1, -40, 0.5, -15)
CloseButton.BackgroundColor3 = Color3.fromRGB(200, 60, 60)
CloseButton.BorderSizePixel = 0
CloseButton.Text = "×"
CloseButton.TextColor3 = Color3.fromRGB(255, 255, 255)
CloseButton.Font = Enum.Font.GothamBold
CloseButton.TextSize = 20
CloseButton.Parent = TitleBar

-- Unhide Button (Hidden by default, shows when main GUI is hidden)
local UnhideButton = Instance.new("TextButton")
UnhideButton.Size = UDim2.new(0, 60, 0, 60)
UnhideButton.Position = UDim2.new(0, 10, 0, 10)
UnhideButton.BackgroundColor3 = Color3.fromRGB(60, 180, 100)
UnhideButton.BorderSizePixel = 0
UnhideButton.Text = "SHOW"
UnhideButton.TextColor3 = Color3.fromRGB(255, 255, 255)
UnhideButton.Font = Enum.Font.GothamBold
UnhideButton.TextSize = 12
UnhideButton.Visible = false
UnhideButton.Parent = ScreenGui

local Content = Instance.new("Frame")
Content.Size = UDim2.new(1, 0, 1, -40)
Content.Position = UDim2.new(0, 0, 0, 40)
Content.BackgroundTransparency = 1
Content.Parent = MainFrame

-- Player List Section
local PlayerListSection = Instance.new("Frame")
PlayerListSection.Size = UDim2.new(1, -20, 0.5, -10)
PlayerListSection.Position = UDim2.new(0, 10, 0, 10)
PlayerListSection.BackgroundColor3 = Color3.fromRGB(40, 40, 45)
PlayerListSection.BorderSizePixel = 0
PlayerListSection.Parent = Content

local SectionTitle = Instance.new("TextLabel")
SectionTitle.Size = UDim2.new(1, 0, 0, 35)
SectionTitle.BackgroundColor3 = Color3.fromRGB(50, 50, 55)
SectionTitle.BorderSizePixel = 0
SectionTitle.Text = "PLAYER LIST"
SectionTitle.TextColor3 = Color3.fromRGB(200, 200, 200)
SectionTitle.Font = Enum.Font.GothamBold
SectionTitle.TextSize = 14
SectionTitle.Parent = PlayerListSection

local SearchBox = Instance.new("TextBox")
SearchBox.Size = UDim2.new(1, -10, 0, 35)
SearchBox.Position = UDim2.new(0, 5, 0, 40)
SearchBox.BackgroundColor3 = Color3.fromRGB(35, 35, 40)
SearchBox.BorderSizePixel = 0
SearchBox.PlaceholderText = "Search players..."
SearchBox.PlaceholderColor3 = Color3.fromRGB(120, 120, 120)
SearchBox.TextColor3 = Color3.fromRGB(220, 220, 220)
SearchBox.Text = ""
SearchBox.Font = Enum.Font.Gotham
SearchBox.TextSize = 13
SearchBox.Parent = PlayerListSection

local PlayerListFrame = Instance.new("ScrollingFrame")
PlayerListFrame.Size = UDim2.new(1, 0, 1, -85)
PlayerListFrame.Position = UDim2.new(0, 0, 0, 80)
PlayerListFrame.BackgroundColor3 = Color3.fromRGB(35, 35, 40)
PlayerListFrame.BorderSizePixel = 0
PlayerListFrame.AutomaticCanvasSize = Enum.AutomaticSize.Y
PlayerListFrame.ScrollBarThickness = 8
PlayerListFrame.ScrollBarImageColor3 = Color3.fromRGB(80, 80, 85)
PlayerListFrame.Parent = PlayerListSection

local UIListLayout = Instance.new("UIListLayout")
UIListLayout.Padding = UDim.new(0, 3)
UIListLayout.Parent = PlayerListFrame

local TemplateButton = Instance.new("TextButton")
TemplateButton.Size = UDim2.new(1, -10, 0, 55) -- Increased height to show both names
TemplateButton.BackgroundColor3 = Color3.fromRGB(50, 50, 55)
TemplateButton.BorderSizePixel = 0
TemplateButton.Text = ""
TemplateButton.Visible = false
TemplateButton.Parent = PlayerListFrame

-- Control Section
local ControlSection = Instance.new("Frame")
ControlSection.Size = UDim2.new(1, -20, 0.45, -5)
ControlSection.Position = UDim2.new(0, 10, 0.52, 5)
ControlSection.BackgroundColor3 = Color3.fromRGB(40, 40, 45)
ControlSection.BorderSizePixel = 0
ControlSection.Parent = Content

local ControlTitle = Instance.new("TextLabel")
ControlTitle.Size = UDim2.new(1, 0, 0, 35)
ControlTitle.BackgroundColor3 = Color3.fromRGB(50, 50, 55)
ControlTitle.BorderSizePixel = 0
ControlTitle.Text = "FOLLOW CONTROLS"
ControlTitle.TextColor3 = Color3.fromRGB(200, 200, 200)
ControlTitle.Font = Enum.Font.GothamBold
ControlTitle.TextSize = 14
ControlTitle.Parent = ControlSection

local SelectedPlayerLabel = Instance.new("TextLabel")
SelectedPlayerLabel.Size = UDim2.new(1, -20, 0, 60) -- Increased height
SelectedPlayerLabel.Position = UDim2.new(0, 10, 0, 40)
SelectedPlayerLabel.BackgroundColor3 = Color3.fromRGB(35, 35, 40)
SelectedPlayerLabel.BorderSizePixel = 0
SelectedPlayerLabel.Text = "Selected: None"
SelectedPlayerLabel.TextColor3 = Color3.fromRGB(180, 180, 180)
SelectedPlayerLabel.Font = Enum.Font.Gotham
SelectedPlayerLabel.TextSize = 13
SelectedPlayerLabel.TextWrapped = true
SelectedPlayerLabel.Parent = ControlSection

local StatusLabel = Instance.new("TextLabel")
StatusLabel.Size = UDim2.new(1, -20, 0, 30)
StatusLabel.Position = UDim2.new(0, 10, 0, 105) -- Adjusted position
StatusLabel.BackgroundTransparency = 1
StatusLabel.Text = "Status: Idle"
StatusLabel.TextColor3 = Color3.fromRGB(150, 200, 150)
StatusLabel.Font = Enum.Font.Gotham
StatusLabel.TextSize = 13
StatusLabel.TextXAlignment = Enum.TextXAlignment.Left
StatusLabel.Parent = ControlSection

local InfoLabel = Instance.new("TextLabel")
InfoLabel.Size = UDim2.new(1, -20, 0, 40)
InfoLabel.Position = UDim2.new(0, 10, 0, 135) -- Adjusted position
InfoLabel.BackgroundTransparency = 1
InfoLabel.Text = "Mode: Floating Follow\nDistance: 4 | Height: 4"
InfoLabel.TextColor3 = Color3.fromRGB(200, 200, 100)
InfoLabel.Font = Enum.Font.Gotham
InfoLabel.TextSize = 11
InfoLabel.TextXAlignment = Enum.TextXAlignment.Left
InfoLabel.Parent = ControlSection

-- Settings Section
local SettingsSection = Instance.new("Frame")
SettingsSection.Size = UDim2.new(1, -20, 0, 70)
SettingsSection.Position = UDim2.new(0, 10, 0, 170)
SettingsSection.BackgroundColor3 = Color3.fromRGB(40, 40, 45)
SettingsSection.BorderSizePixel = 0
SettingsSection.Parent = ControlSection

local SettingsTitle = Instance.new("TextLabel")
SettingsTitle.Size = UDim2.new(1, 0, 0, 25)
SettingsTitle.BackgroundColor3 = Color3.fromRGB(50, 50, 55)
SettingsTitle.BorderSizePixel = 0
SettingsTitle.Text = "FOLLOW SETTINGS"
SettingsTitle.TextColor3 = Color3.fromRGB(200, 200, 200)
SettingsTitle.Font = Enum.Font.GothamBold
SettingsTitle.TextSize = 12
SettingsTitle.Parent = SettingsSection

local DistanceContainer = Instance.new("Frame")
DistanceContainer.Size = UDim2.new(1, -10, 0, 20)
DistanceContainer.Position = UDim2.new(0, 5, 0.35, 0)
DistanceContainer.BackgroundTransparency = 1
DistanceContainer.Parent = SettingsSection

local DistanceLabel = Instance.new("TextLabel")
DistanceLabel.Size = UDim2.new(0.3, 0, 1, 0)
DistanceLabel.Position = UDim2.new(0, 0, 0, 0)
DistanceLabel.BackgroundTransparency = 1
DistanceLabel.Text = "Distance:"
DistanceLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
DistanceLabel.Font = Enum.Font.Gotham
DistanceLabel.TextSize = 12
DistanceLabel.TextXAlignment = Enum.TextXAlignment.Left
DistanceLabel.Parent = DistanceContainer

local DistanceValue = Instance.new("TextLabel")
DistanceValue.Size = UDim2.new(0.2, 0, 1, 0)
DistanceValue.Position = UDim2.new(0.3, 0, 0, 0)
DistanceValue.BackgroundTransparency = 1
DistanceValue.Text = "4"
DistanceValue.TextColor3 = Color3.fromRGB(100, 200, 255)
DistanceValue.Font = Enum.Font.GothamBold
DistanceValue.TextSize = 12
DistanceValue.Parent = DistanceContainer

local DistanceMinus = Instance.new("TextButton")
DistanceMinus.Size = UDim2.new(0, 25, 0, 20)
DistanceMinus.Position = UDim2.new(0.55, 0, 0, 0)
DistanceMinus.BackgroundColor3 = Color3.fromRGB(60, 60, 70)
DistanceMinus.BorderSizePixel = 0
DistanceMinus.Text = "-"
DistanceMinus.TextColor3 = Color3.fromRGB(255, 255, 255)
DistanceMinus.Font = Enum.Font.GothamBold
DistanceMinus.TextSize = 14
DistanceMinus.Parent = DistanceContainer

local DistancePlus = Instance.new("TextButton")
DistancePlus.Size = UDim2.new(0, 25, 0, 20)
DistancePlus.Position = UDim2.new(0.8, 0, 0, 0)
DistancePlus.BackgroundColor3 = Color3.fromRGB(60, 60, 70)
DistancePlus.BorderSizePixel = 0
DistancePlus.Text = "+"
DistancePlus.TextColor3 = Color3.fromRGB(255, 255, 255)
DistancePlus.Font = Enum.Font.GothamBold
DistancePlus.TextSize = 14
DistancePlus.Parent = DistanceContainer

local HeightContainer = Instance.new("Frame")
HeightContainer.Size = UDim2.new(1, -10, 0, 20)
HeightContainer.Position = UDim2.new(0, 5, 0.7, 0)
HeightContainer.BackgroundTransparency = 1
HeightContainer.Parent = SettingsSection

local HeightLabel = Instance.new("TextLabel")
HeightLabel.Size = UDim2.new(0.3, 0, 1, 0)
HeightLabel.Position = UDim2.new(0, 0, 0, 0)
HeightLabel.BackgroundTransparency = 1
HeightLabel.Text = "Height:"
HeightLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
HeightLabel.Font = Enum.Font.Gotham
HeightLabel.TextSize = 12
HeightLabel.TextXAlignment = Enum.TextXAlignment.Left
HeightLabel.Parent = HeightContainer

local HeightValue = Instance.new("TextLabel")
HeightValue.Size = UDim2.new(0.2, 0, 1, 0)
HeightValue.Position = UDim2.new(0.3, 0, 0, 0)
HeightValue.BackgroundTransparency = 1
HeightValue.Text = "4"
HeightValue.TextColor3 = Color3.fromRGB(100, 200, 255)
HeightValue.Font = Enum.Font.GothamBold
HeightValue.TextSize = 12
HeightValue.Parent = HeightContainer

local HeightMinus = Instance.new("TextButton")
HeightMinus.Size = UDim2.new(0, 25, 0, 20)
HeightMinus.Position = UDim2.new(0.55, 0, 0, 0)
HeightMinus.BackgroundColor3 = Color3.fromRGB(60, 60, 70)
HeightMinus.BorderSizePixel = 0
HeightMinus.Text = "-"
HeightMinus.TextColor3 = Color3.fromRGB(255, 255, 255)
HeightMinus.Font = Enum.Font.GothamBold
HeightMinus.TextSize = 14
HeightMinus.Parent = HeightContainer

local HeightPlus = Instance.new("TextButton")
HeightPlus.Size = UDim2.new(0, 25, 0, 20)
HeightPlus.Position = UDim2.new(0.8, 0, 0, 0)
HeightPlus.BackgroundColor3 = Color3.fromRGB(60, 60, 70)
HeightPlus.BorderSizePixel = 0
HeightPlus.Text = "+"
HeightPlus.TextColor3 = Color3.fromRGB(255, 255, 255)
HeightPlus.Font = Enum.Font.GothamBold
HeightPlus.TextSize = 14
HeightPlus.Parent = HeightContainer

-- Action Buttons Section
local ActionSection = Instance.new("Frame")
ActionSection.Size = UDim2.new(1, -20, 0, 50)
ActionSection.Position = UDim2.new(0, 10, 1, -65)
ActionSection.BackgroundTransparency = 1
ActionSection.Parent = ControlSection

local StickButton = Instance.new("TextButton")
StickButton.Size = UDim2.new(0.48, 0, 1, 0)
StickButton.Position = UDim2.new(0, 0, 0, 0)
StickButton.BackgroundColor3 = Color3.fromRGB(50, 180, 70)
StickButton.BorderSizePixel = 0
StickButton.Text = "STICK"
StickButton.TextColor3 = Color3.fromRGB(255, 255, 255)
StickButton.Font = Enum.Font.GothamBold
StickButton.TextSize = 14
StickButton.Parent = ActionSection

local UnstickButton = Instance.new("TextButton")
UnstickButton.Size = UDim2.new(0.48, 0, 1, 0)
UnstickButton.Position = UDim2.new(0.52, 0, 0, 0)
UnstickButton.BackgroundColor3 = Color3.fromRGB(180, 60, 60)
UnstickButton.BorderSizePixel = 0
UnstickButton.Text = "UNSTICK"
UnstickButton.TextColor3 = Color3.fromRGB(255, 255, 255)
UnstickButton.Font = Enum.Font.GothamBold
UnstickButton.TextSize = 14
UnstickButton.Parent = ActionSection

-- Variables
local selectedPlayer = nil
local sticking = false
local stickConnection = nil
local lastHighlight = nil
local playerButtons = {}
local searchFilter = ""
local targetDistance = 4
local followHeight = 4
local maxFollowSpeed = 100
local currentSpeed = 0
local smoothness = 0.15
local lastTargetPosition = nil
local targetVelocity = Vector3.new(0, 0, 0)
local predictiveOffset = Vector3.new(0, 0, 0)

-- Body parts for movement
local bodyVelocity = nil
local bodyGyro = nil
local antiGravity = nil

-- TOUCH-SCREEN DRAGGING FUNCTION
local function makeDraggableTouch(frame, dragHandle)
    local dragging = false
    local dragInput
    local dragStartPosition
    local frameStartPosition
    
    local function update(input)
        local delta = input.Position - dragStartPosition
        frame.Position = UDim2.new(
            frameStartPosition.X.Scale,
            frameStartPosition.X.Offset + delta.X,
            frameStartPosition.Y.Scale,
            frameStartPosition.Y.Offset + delta.Y
        )
    end
    
    dragHandle.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            dragging = true
            dragStartPosition = input.Position
            frameStartPosition = frame.Position
            
            dragInput = input
            
            local connection
            connection = input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragging = false
                    if connection then
                        connection:Disconnect()
                    end
                end
            end)
        end
    end)
    
    dragHandle.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
            dragInput = input
        end
    end)
    
    UserInputService.InputChanged:Connect(function(input)
        if dragging and (input == dragInput) then
            update(input)
        end
    end)
end

-- Function to get ground height at position
local function getGroundHeight(position)
    local raycastParams = RaycastParams.new()
    raycastParams.FilterDescendantsInstances = {LocalPlayer.Character}
    raycastParams.FilterType = Enum.RaycastFilterType.Blacklist
    raycastParams.IgnoreWater = true
    
    local rayOrigin = Vector3.new(position.X, position.Y + 100, position.Z)
    local rayDirection = Vector3.new(0, -200, 0)
    local raycastResult = workspace:Raycast(rayOrigin, rayDirection, raycastParams)
    
    if raycastResult then
        return raycastResult.Position.Y
    end
    
    return 0
end

-- Enable Flying Mode
local function enableFlyingMode(character)
    if not character then return end
    
    for _, part in pairs(character:GetDescendants()) do
        if part:IsA("BasePart") then
            part.CanCollide = false
        end
    end
    
    local humanoidRootPart = character:FindFirstChild("HumanoidRootPart")
    if humanoidRootPart then
        if bodyVelocity then bodyVelocity:Destroy() end
        if bodyGyro then bodyGyro:Destroy() end
        if antiGravity then antiGravity:Destroy() end
        
        bodyVelocity = Instance.new("BodyVelocity")
        bodyVelocity.Name = "FollowBodyVelocity"
        bodyVelocity.MaxForce = Vector3.new(40000, 0, 40000)
        bodyVelocity.P = 1000
        bodyVelocity.Velocity = Vector3.new(0, 0, 0)
        bodyVelocity.Parent = humanoidRootPart
        
        bodyGyro = Instance.new("BodyGyro")
        bodyGyro.Name = "FollowBodyGyro"
        bodyGyro.MaxTorque = Vector3.new(40000, 40000, 40000)
        bodyGyro.P = 3000
        bodyGyro.D = 500
        bodyGyro.CFrame = humanoidRootPart.CFrame
        bodyGyro.Parent = humanoidRootPart
        
        antiGravity = Instance.new("BodyForce")
        antiGravity.Name = "AntiGravityForce"
        antiGravity.Force = Vector3.new(0, character:GetMass() * workspace.Gravity, 0)
        antiGravity.Parent = humanoidRootPart
    end
    
    InfoLabel.Text = string.format("Mode: Floating Follow\nDistance: %d | Height: %d", targetDistance, followHeight)
end

-- Disable Flying Mode
local function disableFlyingMode(character)
    if not character then return end
    
    for _, part in pairs(character:GetDescendants()) do
        if part:IsA("BasePart") then
            part.CanCollide = true
        end
    end
    
    if bodyVelocity then
        bodyVelocity:Destroy()
        bodyVelocity = nil
    end
    
    if bodyGyro then
        bodyGyro:Destroy()
        bodyGyro = nil
    end
    
    if antiGravity then
        antiGravity:Destroy()
        antiGravity = nil
    end
    
    InfoLabel.Text = string.format("Mode: Floating Follow\nDistance: %d | Height: %d", targetDistance, followHeight)
end

-- Get target's primary part with vehicle detection
local function getTargetPrimaryPart(character)
    if not character then return nil, "unknown" end
    
    local humanoid = character:FindFirstChildOfClass("Humanoid")
    
    if humanoid and humanoid.SeatPart then
        local vehicle = humanoid.SeatPart.Parent
        
        local assemblyRoot = vehicle:FindFirstChild("AssemblyRootPart")
        if assemblyRoot and assemblyRoot:IsA("BasePart") then
            return assemblyRoot, "vehicle"
        end
        
        if vehicle:IsA("Model") and vehicle.PrimaryPart then
            return vehicle.PrimaryPart, "vehicle"
        end
        
        return humanoid.SeatPart, "vehicle"
    end
    
    local rootPart = character:FindFirstChild("HumanoidRootPart")
    if rootPart then return rootPart, "humanoid" end
    
    local torso = character:FindFirstChild("Torso") or character:FindFirstChild("UpperTorso")
    if torso then return torso, "humanoid" end
    
    for _, part in pairs(character:GetChildren()) do
        if part:IsA("BasePart") then
            return part, "humanoid"
        end
    end
    
    return nil, "unknown"
end

-- Calculate dynamic follow speed
local function calculateDynamicSpeed(targetVelocity, targetType)
    local baseSpeed = 25
    local velocityMagnitude = targetVelocity.Magnitude
    
    if targetType == "vehicle" then
        baseSpeed = 40
    end
    
    local additionalSpeed = velocityMagnitude * 1.2
    local calculatedSpeed = math.min(baseSpeed + additionalSpeed, maxFollowSpeed)
    
    if currentSpeed == 0 then
        currentSpeed = calculatedSpeed
    else
        currentSpeed = currentSpeed + (calculatedSpeed - currentSpeed) * smoothness
    end
    
    return currentSpeed
end

-- Calculate predictive offset
local function calculatePredictiveOffset(targetVelocity, deltaTime)
    local lookAheadTime = 0.3
    local prediction = targetVelocity * lookAheadTime
    
    if prediction.Magnitude > 20 then
        prediction = prediction.Unit * 20
    end
    
    predictiveOffset = predictiveOffset + (prediction - predictiveOffset) * 0.1
    return predictiveOffset
end

-- Smart stick follow function
local function smartStickFollow()
    if not sticking then return end
    if not selectedPlayer then 
        unstickFromPlayer()
        return 
    end
    
    local character = LocalPlayer.Character
    local targetCharacter = selectedPlayer.Character
    
    if not character or not targetCharacter then 
        StatusLabel.Text = "Status: Character missing"
        return 
    end
    
    local rootPart = character:FindFirstChild("HumanoidRootPart")
    local targetPrimary, targetType = getTargetPrimaryPart(targetCharacter)
    
    if not rootPart or not targetPrimary then 
        StatusLabel.Text = "Status: Cannot find body parts"
        return 
    end
    
    local currentTargetPosition = targetPrimary.Position
    if lastTargetPosition then
        local deltaTime = RunService.Heartbeat:Wait()
        local positionDelta = currentTargetPosition - lastTargetPosition
        targetVelocity = positionDelta / deltaTime
        targetVelocity = targetVelocity:Lerp(Vector3.new(0, 0, 0), 0.3)
    end
    lastTargetPosition = currentTargetPosition
    
    local speed = calculateDynamicSpeed(targetVelocity, targetType)
    local deltaTime = RunService.Heartbeat:Wait()
    local prediction = calculatePredictiveOffset(targetVelocity, deltaTime)
    
    local targetCFrame = targetPrimary.CFrame
    local baseOffset = Vector3.new(0, followHeight, -targetDistance)
    local desiredLocalPosition = baseOffset + prediction
    local desiredWorldPosition = targetCFrame:PointToWorldSpace(desiredLocalPosition)
    
    -- Anti-baseplate protection
    local targetGroundHeight = getGroundHeight(currentTargetPosition)
    local ourGroundHeight = getGroundHeight(desiredWorldPosition)
    local minSafeHeight = math.max(targetGroundHeight, ourGroundHeight) + followHeight
    
    if currentTargetPosition.Y > targetGroundHeight + 2 then
        minSafeHeight = currentTargetPosition.Y + followHeight - 2
    end
    
    if desiredWorldPosition.Y < minSafeHeight then
        desiredWorldPosition = Vector3.new(
            desiredWorldPosition.X,
            minSafeHeight,
            desiredWorldPosition.Z
        )
    end
    
    local absoluteMinHeight = 2
    if desiredWorldPosition.Y < absoluteMinHeight then
        desiredWorldPosition = Vector3.new(
            desiredWorldPosition.X,
            absoluteMinHeight,
            desiredWorldPosition.Z
        )
    end
    
    local direction = Vector3.new(
        desiredWorldPosition.X - rootPart.Position.X,
        0,
        desiredWorldPosition.Z - rootPart.Position.Z
    )
    local horizontalDistance = direction.Magnitude
    
    local verticalDifference = desiredWorldPosition.Y - rootPart.Position.Y
    if antiGravity then
        local gravityAdjustment = 0
        if verticalDifference > 1 then
            gravityAdjustment = verticalDifference * 100
        elseif verticalDifference < -1 then
            gravityAdjustment = -verticalDifference * 50
        end
        
        local mass = character:GetMass()
        antiGravity.Force = Vector3.new(0, (mass * workspace.Gravity) + gravityAdjustment, 0)
    end
    
    if horizontalDistance < targetDistance * 0.5 then
        speed = speed * 0.5
    elseif horizontalDistance > targetDistance * 2 then
        speed = speed * 1.5
    end
    
    speed = math.clamp(speed, 5, maxFollowSpeed)
    
    if horizontalDistance > 0.5 then
        local velocityDirection = direction.Unit
        
        if horizontalDistance < 3 then
            local dampingFactor = horizontalDistance / 3
            speed = speed * dampingFactor
        end
        
        local desiredVelocity = velocityDirection * speed
        
        if bodyVelocity then
            bodyVelocity.Velocity = desiredVelocity
        end
        
        if bodyGyro then
            local lookAtPosition = Vector3.new(targetPrimary.Position.X, rootPart.Position.Y, targetPrimary.Position.Z)
            local lookAtCFrame = CFrame.new(rootPart.Position, lookAtPosition)
            bodyGyro.CFrame = lookAtCFrame
        end
    else
        if bodyVelocity then
            bodyVelocity.Velocity = Vector3.new(0, 0, 0)
        end
    end
    
    InfoLabel.Text = string.format("Mode: Floating Follow\nDistance: %d | Height: %d", targetDistance, followHeight)
    StatusLabel.Text = string.format("Status: STICKING (%s)\nDistance: %.1f studs", 
        selectedPlayer.DisplayName, horizontalDistance)
    StatusLabel.TextColor3 = Color3.fromRGB(100, 255, 100)
end

-- Start sticking to player
local function stickToPlayer()
    if sticking then 
        StatusLabel.Text = "Status: Already sticking!"
        StatusLabel.TextColor3 = Color3.fromRGB(255, 200, 100)
        return 
    end
    
    if not selectedPlayer then 
        StatusLabel.Text = "Status: Select a player first!"
        StatusLabel.TextColor3 = Color3.fromRGB(255, 150, 150)
        return 
    end
    
    StatusLabel.Text = "Status: Initializing stick..."
    StatusLabel.TextColor3 = Color3.fromRGB(255, 200, 100)
    
    local character = LocalPlayer.Character
    if not character then
        character = LocalPlayer.CharacterAdded:Wait()
        task.wait(0.5)
    end
    
    enableFlyingMode(character)
    
    sticking = true
    lastTargetPosition = nil
    predictiveOffset = Vector3.new(0, 0, 0)
    
    if stickConnection then
        stickConnection:Disconnect()
    end
    
    stickConnection = RunService.Heartbeat:Connect(function()
        smartStickFollow()
    end)
    
    StickButton.BackgroundColor3 = Color3.fromRGB(30, 150, 50)
    UnstickButton.BackgroundColor3 = Color3.fromRGB(180, 60, 60)
    
    StatusLabel.Text = "Status: STICKING ACTIVE"
    StatusLabel.TextColor3 = Color3.fromRGB(100, 255, 100)
end

-- Stop sticking to player
local function unstickFromPlayer()
    sticking = false
    currentSpeed = 0
    
    if stickConnection then
        stickConnection:Disconnect()
        stickConnection = nil
    end
    
    local character = LocalPlayer.Character
    if character then
        disableFlyingMode(character)
    end
    
    StickButton.BackgroundColor3 = Color3.fromRGB(50, 180, 70)
    UnstickButton.BackgroundColor3 = Color3.fromRGB(180, 60, 60)
    
    StatusLabel.Text = "Status: Idle"
    StatusLabel.TextColor3 = Color3.fromRGB(150, 200, 150)
    InfoLabel.Text = string.format("Mode: Floating Follow\nDistance: %d | Height: %d", targetDistance, followHeight)
end

-- Update player list with search - CLEARLY SHOW BOTH NAMES
local function updatePlayerList()
    for _, button in pairs(playerButtons) do
        button:Destroy()
    end
    playerButtons = {}
    
    for _, player in pairs(Players:GetPlayers()) do
        if player ~= LocalPlayer then
            if searchFilter == "" or 
               string.find(string.lower(player.Name), string.lower(searchFilter)) or
               string.find(string.lower(player.DisplayName), string.lower(searchFilter)) then
                
                local button = TemplateButton:Clone()
                button.Name = "PlayerButton_" .. player.Name
                button.Visible = true
                button.BackgroundColor3 = selectedPlayer == player and Color3.fromRGB(80, 120, 200) or Color3.fromRGB(50, 50, 55)
                button.Parent = PlayerListFrame
                table.insert(playerButtons, button)
                
                -- Username Label (Roblox Account Name)
                local usernameContainer = Instance.new("Frame")
                usernameContainer.Size = UDim2.new(1, -10, 0, 20)
                usernameContainer.Position = UDim2.new(0, 5, 0, 5)
                usernameContainer.BackgroundTransparency = 1
                usernameContainer.Parent = button
                
                local usernamePrefix = Instance.new("TextLabel")
                usernamePrefix.Size = UDim2.new(0, 60, 1, 0)
                usernamePrefix.Position = UDim2.new(0, 0, 0, 0)
                usernamePrefix.BackgroundTransparency = 1
                usernamePrefix.Text = "Username:"
                usernamePrefix.TextColor3 = Color3.fromRGB(180, 180, 180)
                usernamePrefix.Font = Enum.Font.Gotham
                usernamePrefix.TextSize = 10
                usernamePrefix.TextXAlignment = Enum.TextXAlignment.Left
                usernamePrefix.Parent = usernameContainer
                
                local usernameValue = Instance.new("TextLabel")
                usernameValue.Size = UDim2.new(1, -60, 1, 0)
                usernameValue.Position = UDim2.new(0, 60, 0, 0)
                usernameValue.BackgroundTransparency = 1
                usernameValue.Text = player.Name
                usernameValue.TextColor3 = Color3.fromRGB(180, 180, 255)
                usernameValue.Font = Enum.Font.GothamBold
                usernameValue.TextSize = 11
                usernameValue.TextXAlignment = Enum.TextXAlignment.Left
                usernameValue.Parent = usernameContainer
                
                -- Display Name Label (Nickname)
                local displayNameContainer = Instance.new("Frame")
                displayNameContainer.Size = UDim2.new(1, -10, 0, 20)
                displayNameContainer.Position = UDim2.new(0, 5, 0, 25)
                displayNameContainer.BackgroundTransparency = 1
                displayNameContainer.Parent = button
                
                local displayNamePrefix = Instance.new("TextLabel")
                displayNamePrefix.Size = UDim2.new(0, 60, 1, 0)
                displayNamePrefix.Position = UDim2.new(0, 0, 0, 0)
                displayNamePrefix.BackgroundTransparency = 1
                displayNamePrefix.Text = "Nickname:"
                displayNamePrefix.TextColor3 = Color3.fromRGB(180, 180, 180)
                displayNamePrefix.Font = Enum.Font.Gotham
                displayNamePrefix.TextSize = 10
                displayNamePrefix.TextXAlignment = Enum.TextXAlignment.Left
                displayNamePrefix.Parent = displayNameContainer
                
                local displayNameValue = Instance.new("TextLabel")
                displayNameValue.Size = UDim2.new(1, -60, 1, 0)
                displayNameValue.Position = UDim2.new(0, 60, 0, 0)
                displayNameValue.BackgroundTransparency = 1
                displayNameValue.Text = player.DisplayName
                displayNameValue.TextColor3 = Color3.fromRGB(255, 180, 180)
                displayNameValue.Font = Enum.Font.GothamBold
                displayNameValue.TextSize = 11
                displayNameValue.TextXAlignment = Enum.TextXAlignment.Left
                displayNameValue.Parent = displayNameContainer
                
                -- Vehicle indicator
                local vehicleIndicator = Instance.new("Frame")
                vehicleIndicator.Size = UDim2.new(0, 8, 0.5, 0)
                vehicleIndicator.Position = UDim2.new(1, -15, 0.25, 0)
                vehicleIndicator.BackgroundColor3 = Color3.fromRGB(100, 100, 100)
                vehicleIndicator.BorderSizePixel = 0
                vehicleIndicator.Parent = button
                
                -- Monitor player's vehicle status
                local function updateIndicator()
                    if player.Character then
                        local _, targetType = getTargetPrimaryPart(player.Character)
                        if targetType == "vehicle" then
                            vehicleIndicator.BackgroundColor3 = Color3.fromRGB(0, 200, 255)
                        else
                            vehicleIndicator.BackgroundColor3 = Color3.fromRGB(100, 100, 100)
                        end
                    end
                end
                
                player.CharacterAdded:Connect(updateIndicator)
                if player.Character then
                    updateIndicator()
                end
                
                if selectedPlayer == player then
                    lastHighlight = button
                end
                
                button.MouseButton1Click:Connect(function()
                    if lastHighlight then
                        lastHighlight.BackgroundColor3 = Color3.fromRGB(50, 50, 55)
                    end
                    
                    selectedPlayer = player
                    lastHighlight = button
                    button.BackgroundColor3 = Color3.fromRGB(80, 120, 200)
                    
                    -- Update selected player display with both names
                    SelectedPlayerLabel.Text = string.format("Selected Player:\nUsername: %s\nNickname: %s", 
                        player.Name, player.DisplayName)
                    StatusLabel.Text = "Status: Ready to stick"
                    StatusLabel.TextColor3 = Color3.fromRGB(150, 200, 150)
                end)
            end
        end
    end
end

-- Handle player leaving
local function handlePlayerLeaving(player)
    if player == selectedPlayer then
        selectedPlayer = nil
        if lastHighlight then
            lastHighlight.BackgroundColor3 = Color3.fromRGB(50, 50, 55)
            lastHighlight = nil
        end
        SelectedPlayerLabel.Text = "Selected: None"
        unstickFromPlayer()
        StatusLabel.Text = "Status: Player left game"
        StatusLabel.TextColor3 = Color3.fromRGB(255, 150, 150)
        
        task.delay(3, function()
            if StatusLabel.Text == "Status: Player left game" then
                StatusLabel.Text = "Status: Idle"
                StatusLabel.TextColor3 = Color3.fromRGB(150, 200, 150)
            end
        end)
    end
    task.wait(0.5)
    updatePlayerList()
end

-- Handle player joining
local function handlePlayerJoining(player)
    task.wait(0.5)
    updatePlayerList()
    
    StatusLabel.Text = string.format("Status: %s (%s) joined", player.DisplayName, player.Name)
    StatusLabel.TextColor3 = Color3.fromRGB(150, 200, 255)
    task.wait(2)
    if StatusLabel.Text == string.format("Status: %s (%s) joined", player.DisplayName, player.Name) then
        StatusLabel.Text = "Status: Idle"
        StatusLabel.TextColor3 = Color3.fromRGB(150, 200, 150)
    end
end

-- HIDE/SHOW FUNCTIONS
local function hideGUI()
    MainFrame.Visible = false
    UnhideButton.Visible = true
    UnhideButton.Position = MainFrame.Position
end

local function showGUI()
    MainFrame.Visible = true
    UnhideButton.Visible = false
end

-- Update distance and height displays
local function updateSettingsDisplay()
    DistanceValue.Text = tostring(targetDistance)
    HeightValue.Text = tostring(followHeight)
    InfoLabel.Text = string.format("Mode: Floating Follow\nDistance: %d | Height: %d", targetDistance, followHeight)
end

-- Distance controls
DistanceMinus.MouseButton1Click:Connect(function()
    targetDistance = math.max(2, targetDistance - 1)
    updateSettingsDisplay()
end)

DistancePlus.MouseButton1Click:Connect(function()
    targetDistance = math.min(20, targetDistance + 1)
    updateSettingsDisplay()
end)

-- Height controls
HeightMinus.MouseButton1Click:Connect(function()
    followHeight = math.max(2, followHeight - 1)
    updateSettingsDisplay()
end)

HeightPlus.MouseButton1Click:Connect(function()
    followHeight = math.min(10, followHeight + 1)
    updateSettingsDisplay()
end)

-- Make GUI draggable
makeDraggableTouch(MainFrame, DragArea)
makeDraggableTouch(UnhideButton, UnhideButton)

-- Hide button functionality
HideButton.MouseButton1Click:Connect(function()
    hideGUI()
end)

-- Unhide button functionality
UnhideButton.MouseButton1Click:Connect(function()
    showGUI()
end)

-- Search functionality
SearchBox:GetPropertyChangedSignal("Text"):Connect(function()
    searchFilter = SearchBox.Text
    updatePlayerList()
end)

-- Stick button
StickButton.MouseButton1Click:Connect(function()
    if selectedPlayer then
        StickButton.BackgroundColor3 = Color3.fromRGB(30, 130, 50)
        task.spawn(stickToPlayer)
        task.wait(0.1)
        StickButton.BackgroundColor3 = sticking and Color3.fromRGB(30, 150, 50) or Color3.fromRGB(50, 180, 70)
    else
        StatusLabel.Text = "Status: SELECT A PLAYER FIRST!"
        StatusLabel.TextColor3 = Color3.fromRGB(255, 150, 150)
        task.wait(2)
        if StatusLabel.Text == "Status: SELECT A PLAYER FIRST!" then
            StatusLabel.Text = "Status: Idle"
            StatusLabel.TextColor3 = Color3.fromRGB(150, 200, 150)
        end
    end
end)

-- Unstick button
UnstickButton.MouseButton1Click:Connect(unstickFromPlayer)

-- Close button destroys the GUI
CloseButton.MouseButton1Click:Connect(function() 
    unstickFromPlayer()
    ScreenGui:Destroy() 
end)

-- Initial setup
updatePlayerList()
updateSettingsDisplay()

-- Auto-refresh player list
task.spawn(function()
    while ScreenGui.Parent and ScreenGui.Parent == PlayerGui do
        updatePlayerList()
        task.wait(2)
    end
end)

-- Connect player events
Players.PlayerAdded:Connect(handlePlayerJoining)
Players.PlayerRemoving:Connect(handlePlayerLeaving)

-- Auto-unstick when character respawns
LocalPlayer.CharacterAdded:Connect(function(character)
    unstickFromPlayer()
    task.wait(1)
    local humanoid = character:FindFirstChildOfClass("Humanoid")
    if humanoid then
        humanoid.Died:Connect(function()
            unstickFromPlayer()
        end)
    end
end)

-- Handle initial character death
if LocalPlayer.Character then
    local humanoid = LocalPlayer.Character:FindFirstChildOfClass("Humanoid")
    if humanoid then
        humanoid.Died:Connect(function()
            unstickFromPlayer()
        end)
    end
end
