local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local LocalPlayer = Players.LocalPlayer
local PlayerGui = LocalPlayer:WaitForChild("PlayerGui")

-- GUI Creation
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "SmartFlyFollowGUI"
ScreenGui.ResetOnSpawn = false
ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
ScreenGui.Parent = PlayerGui

-- Main Container Frame (BIGGER SIZE - Updated from screenshot feedback)
local MainFrame = Instance.new("Frame")
MainFrame.Size = UDim2.new(0, 450, 0, 650) -- Increased size
MainFrame.Position = UDim2.new(0.5, -225, 0.5, -325)
MainFrame.BackgroundColor3 = Color3.fromRGB(30, 30, 35)
MainFrame.BorderSizePixel = 0
MainFrame.ClipsDescendants = true
MainFrame.Active = true
MainFrame.Selectable = true
MainFrame.Parent = ScreenGui

-- Title Bar with Drag Functionality
local TitleBar = Instance.new("Frame")
TitleBar.Size = UDim2.new(1, 0, 0, 40)
TitleBar.BackgroundColor3 = Color3.fromRGB(45, 45, 50)
TitleBar.BorderSizePixel = 0
TitleBar.Parent = MainFrame

-- Draggable area in title bar (TOUCH-COMPATIBLE)
local DragArea = Instance.new("TextButton")
DragArea.Size = UDim2.new(1, -80, 1, 0)
DragArea.Position = UDim2.new(0, 0, 0, 0)
DragArea.BackgroundTransparency = 1
DragArea.Text = ""
DragArea.TextTransparency = 1
DragArea.Parent = TitleBar

local TitleText = Instance.new("TextLabel")
TitleText.Size = UDim2.new(1, -80, 1, 0)
TitleText.Position = UDim2.new(0, 15, 0, 0)
TitleText.BackgroundTransparency = 1
TitleText.Text = "SMART FLY FOLLOW"
TitleText.TextColor3 = Color3.fromRGB(220, 220, 220)
TitleText.Font = Enum.Font.GothamBold
TitleText.TextSize = 18 -- Increased
TitleText.TextXAlignment = Enum.TextXAlignment.Left
TitleText.Parent = TitleBar

-- Hide Button
local HideButton = Instance.new("TextButton")
HideButton.Size = UDim2.new(0, 30, 0, 30)
HideButton.Position = UDim2.new(1, -75, 0.5, -15)
HideButton.BackgroundColor3 = Color3.fromRGB(60, 120, 200)
HideButton.BorderSizePixel = 0
HideButton.Text = "—"
HideButton.TextColor3 = Color3.fromRGB(255, 255, 255)
HideButton.Font = Enum.Font.GothamBold
HideButton.TextSize = 16
HideButton.Parent = TitleBar

-- Close Button
local CloseButton = Instance.new("TextButton")
CloseButton.Size = UDim2.new(0, 30, 0, 30)
CloseButton.Position = UDim2.new(1, -40, 0.5, -15)
CloseButton.BackgroundColor3 = Color3.fromRGB(200, 60, 60)
CloseButton.BorderSizePixel = 0
CloseButton.Text = "×"
CloseButton.TextColor3 = Color3.fromRGB(255, 255, 255)
CloseButton.Font = Enum.Font.GothamBold
CloseButton.TextSize = 20
CloseButton.Parent = TitleBar

-- Unhide Button (Hidden by default, shows when main GUI is hidden)
local UnhideButton = Instance.new("TextButton")
UnhideButton.Size = UDim2.new(0, 70, 0, 70) -- Bigger
UnhideButton.Position = UDim2.new(0, 10, 0, 10)
UnhideButton.BackgroundColor3 = Color3.fromRGB(60, 180, 100)
UnhideButton.BorderSizePixel = 0
UnhideButton.Text = "SHOW"
UnhideButton.TextColor3 = Color3.fromRGB(255, 255, 255)
UnhideButton.Font = Enum.Font.GothamBold
UnhideButton.TextSize = 14
UnhideButton.Visible = false
UnhideButton.Parent = ScreenGui

local Content = Instance.new("Frame")
Content.Size = UDim2.new(1, 0, 1, -40)
Content.Position = UDim2.new(0, 0, 0, 40)
Content.BackgroundTransparency = 1
Content.Parent = MainFrame

-- Player List Section
local PlayerListSection = Instance.new("Frame")
PlayerListSection.Size = UDim2.new(1, -20, 0, 300) -- Fixed height
PlayerListSection.Position = UDim2.new(0, 10, 0, 10)
PlayerListSection.BackgroundColor3 = Color3.fromRGB(40, 40, 45)
PlayerListSection.BorderSizePixel = 0
PlayerListSection.Parent = Content

local SectionTitle = Instance.new("TextLabel")
SectionTitle.Size = UDim2.new(1, 0, 0, 35)
SectionTitle.BackgroundColor3 = Color3.fromRGB(50, 50, 55)
SectionTitle.BorderSizePixel = 0
SectionTitle.Text = "PLAYER LIST"
SectionTitle.TextColor3 = Color3.fromRGB(200, 200, 200)
SectionTitle.Font = Enum.Font.GothamBold
SectionTitle.TextSize = 16 -- Increased
SectionTitle.Parent = PlayerListSection

local SearchBox = Instance.new("TextBox")
SearchBox.Size = UDim2.new(1, -10, 0, 35)
SearchBox.Position = UDim2.new(0, 5, 0, 40)
SearchBox.BackgroundColor3 = Color3.fromRGB(35, 35, 40)
SearchBox.BorderSizePixel = 0
SearchBox.PlaceholderText = "Search players..."
SearchBox.PlaceholderColor3 = Color3.fromRGB(120, 120, 120)
SearchBox.TextColor3 = Color3.fromRGB(220, 220, 220)
SearchBox.Text = ""
SearchBox.Font = Enum.Font.Gotham
SearchBox.TextSize = 14
SearchBox.Parent = PlayerListSection

local PlayerListFrame = Instance.new("ScrollingFrame")
PlayerListFrame.Size = UDim2.new(1, 0, 1, -85)
PlayerListFrame.Position = UDim2.new(0, 0, 0, 80)
PlayerListFrame.BackgroundColor3 = Color3.fromRGB(35, 35, 40)
PlayerListFrame.BorderSizePixel = 0
PlayerListFrame.AutomaticCanvasSize = Enum.AutomaticSize.Y
PlayerListFrame.ScrollBarThickness = 10
PlayerListFrame.ScrollBarImageColor3 = Color3.fromRGB(80, 80, 85)
PlayerListFrame.Parent = PlayerListSection

local UIListLayout = Instance.new("UIListLayout")
UIListLayout.Padding = UDim.new(0, 4) -- More spacing
UIListLayout.Parent = PlayerListFrame

local TemplateButton = Instance.new("TextButton")
TemplateButton.Size = UDim2.new(1, -10, 0, 60) -- Taller for better visibility
TemplateButton.BackgroundColor3 = Color3.fromRGB(50, 50, 55)
TemplateButton.BorderSizePixel = 0
TemplateButton.Text = ""
TemplateButton.Visible = false
TemplateButton.Parent = PlayerListFrame

-- Control Section
local ControlSection = Instance.new("Frame")
ControlSection.Size = UDim2.new(1, -20, 0, 290) -- Fixed height
ControlSection.Position = UDim2.new(0, 10, 0, 320) -- Positioned below player list
ControlSection.BackgroundColor3 = Color3.fromRGB(40, 40, 45)
ControlSection.BorderSizePixel = 0
ControlSection.Parent = Content

local ControlTitle = Instance.new("TextLabel")
ControlTitle.Size = UDim2.new(1, 0, 0, 35)
ControlTitle.BackgroundColor3 = Color3.fromRGB(50, 50, 55)
ControlTitle.BorderSizePixel = 0
ControlTitle.Text = "FOLLOW CONTROLS"
ControlTitle.TextColor3 = Color3.fromRGB(200, 200, 200)
ControlTitle.Font = Enum.Font.GothamBold
ControlTitle.TextSize = 16
ControlTitle.Parent = ControlSection

local SelectedPlayerLabel = Instance.new("TextLabel")
SelectedPlayerLabel.Size = UDim2.new(1, -20, 0, 70) -- Taller
SelectedPlayerLabel.Position = UDim2.new(0, 10, 0, 40)
SelectedPlayerLabel.BackgroundColor3 = Color3.fromRGB(35, 35, 40)
SelectedPlayerLabel.BorderSizePixel = 0
SelectedPlayerLabel.Text = "Selected: None"
SelectedPlayerLabel.TextColor3 = Color3.fromRGB(180, 180, 180)
SelectedPlayerLabel.Font = Enum.Font.Gotham
SelectedPlayerLabel.TextSize = 13
SelectedPlayerLabel.TextWrapped = true
SelectedPlayerLabel.Parent = ControlSection

local StatusLabel = Instance.new("TextLabel")
StatusLabel.Size = UDim2.new(1, -20, 0, 35) -- Taller
StatusLabel.Position = UDim2.new(0, 10, 0, 115)
StatusLabel.BackgroundTransparency = 1
StatusLabel.Text = "Status: Idle"
StatusLabel.TextColor3 = Color3.fromRGB(150, 200, 150)
StatusLabel.Font = Enum.Font.Gotham
StatusLabel.TextSize = 14
StatusLabel.TextXAlignment = Enum.TextXAlignment.Left
StatusLabel.Parent = ControlSection

local InfoLabel = Instance.new("TextLabel")
InfoLabel.Size = UDim2.new(1, -20, 0, 40)
InfoLabel.Position = UDim2.new(0, 10, 0, 155)
InfoLabel.BackgroundTransparency = 1
InfoLabel.Text = "Mode: Floating Follow\nDistance: 4 | Height: 4"
InfoLabel.TextColor3 = Color3.fromRGB(200, 200, 100)
InfoLabel.Font = Enum.Font.Gotham
InfoLabel.TextSize = 12
InfoLabel.TextXAlignment = Enum.TextXAlignment.Left
InfoLabel.Parent = ControlSection

-- Settings Section
local SettingsSection = Instance.new("Frame")
SettingsSection.Size = UDim2.new(1, -20, 0, 80) -- Taller
SettingsSection.Position = UDim2.new(0, 10, 0, 200)
SettingsSection.BackgroundColor3 = Color3.fromRGB(40, 40, 45)
SettingsSection.BorderSizePixel = 0
SettingsSection.Parent = ControlSection

local SettingsTitle = Instance.new("TextLabel")
SettingsTitle.Size = UDim2.new(1, 0, 0, 25)
SettingsTitle.BackgroundColor3 = Color3.fromRGB(50, 50, 55)
SettingsTitle.BorderSizePixel = 0
SettingsTitle.Text = "FOLLOW SETTINGS"
SettingsTitle.TextColor3 = Color3.fromRGB(200, 200, 200)
SettingsTitle.Font = Enum.Font.GothamBold
SettingsTitle.TextSize = 13
SettingsTitle.Parent = SettingsSection

local DistanceContainer = Instance.new("Frame")
DistanceContainer.Size = UDim2.new(1, -10, 0, 25)
DistanceContainer.Position = UDim2.new(0, 5, 0.3, 0)
DistanceContainer.BackgroundTransparency = 1
DistanceContainer.Parent = SettingsSection

local DistanceLabel = Instance.new("TextLabel")
DistanceLabel.Size = UDim2.new(0.35, 0, 1, 0)
DistanceLabel.Position = UDim2.new(0, 0, 0, 0)
DistanceLabel.BackgroundTransparency = 1
DistanceLabel.Text = "Distance:"
DistanceLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
DistanceLabel.Font = Enum.Font.Gotham
DistanceLabel.TextSize = 13
DistanceLabel.TextXAlignment = Enum.TextXAlignment.Left
DistanceLabel.Parent = DistanceContainer

local DistanceValue = Instance.new("TextLabel")
DistanceValue.Size = UDim2.new(0.2, 0, 1, 0)
DistanceValue.Position = UDim2.new(0.35, 0, 0, 0)
DistanceValue.BackgroundTransparency = 1
DistanceValue.Text = "4"
DistanceValue.TextColor3 = Color3.fromRGB(100, 200, 255)
DistanceValue.Font = Enum.Font.GothamBold
DistanceValue.TextSize = 14
DistanceValue.Parent = DistanceContainer

local DistanceMinus = Instance.new("TextButton")
DistanceMinus.Size = UDim2.new(0, 30, 0, 25) -- Wider
DistanceMinus.Position = UDim2.new(0.55, 0, 0, 0)
DistanceMinus.BackgroundColor3 = Color3.fromRGB(60, 60, 70)
DistanceMinus.BorderSizePixel = 0
DistanceMinus.Text = "−"
DistanceMinus.TextColor3 = Color3.fromRGB(255, 255, 255)
DistanceMinus.Font = Enum.Font.GothamBold
DistanceMinus.TextSize = 16
DistanceMinus.Parent = DistanceContainer

local DistancePlus = Instance.new("TextButton")
DistancePlus.Size = UDim2.new(0, 30, 0, 25) -- Wider
DistancePlus.Position = UDim2.new(0.8, 0, 0, 0)
DistancePlus.BackgroundColor3 = Color3.fromRGB(60, 60, 70)
DistancePlus.BorderSizePixel = 0
DistancePlus.Text = "+"
DistancePlus.TextColor3 = Color3.fromRGB(255, 255, 255)
DistancePlus.Font = Enum.Font.GothamBold
DistancePlus.TextSize = 16
DistancePlus.Parent = DistanceContainer

local HeightContainer = Instance.new("Frame")
HeightContainer.Size = UDim2.new(1, -10, 0, 25)
HeightContainer.Position = UDim2.new(0, 5, 0.65, 0)
HeightContainer.BackgroundTransparency = 1
HeightContainer.Parent = SettingsSection

local HeightLabel = Instance.new("TextLabel")
HeightLabel.Size = UDim2.new(0.35, 0, 1, 0)
HeightLabel.Position = UDim2.new(0, 0, 0, 0)
HeightLabel.BackgroundTransparency = 1
HeightLabel.Text = "Height:"
HeightLabel.TextColor3 = Color3.fromRGB(200, 200, 200)
HeightLabel.Font = Enum.Font.Gotham
HeightLabel.TextSize = 13
HeightLabel.TextXAlignment = Enum.TextXAlignment.Left
HeightLabel.Parent = HeightContainer

local HeightValue = Instance.new("TextLabel")
HeightValue.Size = UDim2.new(0.2, 0, 1, 0)
HeightValue.Position = UDim2.new(0.35, 0, 0, 0)
HeightValue.BackgroundTransparency = 1
HeightValue.Text = "4"
HeightValue.TextColor3 = Color3.fromRGB(100, 200, 255)
HeightValue.Font = Enum.Font.GothamBold
HeightValue.TextSize = 14
HeightValue.Parent = HeightContainer

local HeightMinus = Instance.new("TextButton")
HeightMinus.Size = UDim2.new(0, 30, 0, 25)
HeightMinus.Position = UDim2.new(0.55, 0, 0, 0)
HeightMinus.BackgroundColor3 = Color3.fromRGB(60, 60, 70)
HeightMinus.BorderSizePixel = 0
HeightMinus.Text = "−"
HeightMinus.TextColor3 = Color3.fromRGB(255, 255, 255)
HeightMinus.Font = Enum.Font.GothamBold
HeightMinus.TextSize = 16
HeightMinus.Parent = HeightContainer

local HeightPlus = Instance.new("TextButton")
HeightPlus.Size = UDim2.new(0, 30, 0, 25)
HeightPlus.Position = UDim2.new(0.8, 0, 0, 0)
HeightPlus.BackgroundColor3 = Color3.fromRGB(60, 60, 70)
HeightPlus.BorderSizePixel = 0
HeightPlus.Text = "+"
HeightPlus.TextColor3 = Color3.fromRGB(255, 255, 255)
HeightPlus.Font = Enum.Font.GothamBold
HeightPlus.TextSize = 16
HeightPlus.Parent = HeightContainer

-- Action Buttons Section
local ActionSection = Instance.new("Frame")
ActionSection.Size = UDim2.new(1, -20, 0, 50)
ActionSection.Position = UDim2.new(0, 10, 1, -60)
ActionSection.BackgroundTransparency = 1
ActionSection.Parent = ControlSection

local StickButton = Instance.new("TextButton")
StickButton.Size = UDim2.new(0.48, 0, 1, 0)
StickButton.Position = UDim2.new(0, 0, 0, 0)
StickButton.BackgroundColor3 = Color3.fromRGB(50, 180, 70)
StickButton.BorderSizePixel = 0
StickButton.Text = "STICK"
StickButton.TextColor3 = Color3.fromRGB(255, 255, 255)
StickButton.Font = Enum.Font.GothamBold
StickButton.TextSize = 16
StickButton.Parent = ActionSection

local UnstickButton = Instance.new("TextButton")
UnstickButton.Size = UDim2.new(0.48, 0, 1, 0)
UnstickButton.Position = UDim2.new(0.52, 0, 0, 0)
UnstickButton.BackgroundColor3 = Color3.fromRGB(180, 60, 60)
UnstickButton.BorderSizePixel = 0
UnstickButton.Text = "UNSTICK"
UnstickButton.TextColor3 = Color3.fromRGB(255, 255, 255)
UnstickButton.Font = Enum.Font.GothamBold
UnstickButton.TextSize = 16
UnstickButton.Parent = ActionSection

-- Variables
local selectedPlayer = nil
local sticking = false
local stickConnection = nil
local lastHighlight = nil
local playerButtons = {}
local searchFilter = ""
local targetDistance = 4
local followHeight = 4
local maxFollowSpeed = 120
local currentSpeed = 0
local smoothness = 0.1 -- Smoother transitions
local lastTargetPosition = nil
local targetVelocity = Vector3.new(0, 0, 0)
local predictiveOffset = Vector3.new(0, 0, 0)
local lastTargetType = "humanoid"
local smoothTransitionFactor = 0.2 -- For smooth type transitions

-- Body parts for movement
local bodyVelocity = nil
local bodyGyro = nil
local antiGravity = nil

-- TOUCH-SCREEN DRAGGING FUNCTION
local function makeDraggableTouch(frame, dragHandle)
    local dragging = false
    local dragInput
    local dragStartPosition
    local frameStartPosition
    
    local function update(input)
        local delta = input.Position - dragStartPosition
        frame.Position = UDim2.new(
            frameStartPosition.X.Scale,
            frameStartPosition.X.Offset + delta.X,
            frameStartPosition.Y.Scale,
            frameStartPosition.Y.Offset + delta.Y
        )
    end
    
    dragHandle.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 or input.UserInputType == Enum.UserInputType.Touch then
            dragging = true
            dragStartPosition = input.Position
            frameStartPosition = frame.Position
            
            dragInput = input
            
            local connection
            connection = input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    dragging = false
                    if connection then
                        connection:Disconnect()
                    end
                end
            end)
        end
    end)
    
    dragHandle.InputChanged:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseMovement or input.UserInputType == Enum.UserInputType.Touch then
            dragInput = input
        end
    end)
    
    UserInputService.InputChanged:Connect(function(input)
        if dragging and (input == dragInput) then
            update(input)
        end
    end)
end

-- Function to get ground height at position
local function getGroundHeight(position)
    local raycastParams = RaycastParams.new()
    raycastParams.FilterDescendantsInstances = {LocalPlayer.Character}
    raycastParams.FilterType = Enum.RaycastFilterType.Blacklist
    raycastParams.IgnoreWater = true
    
    local rayOrigin = Vector3.new(position.X, position.Y + 100, position.Z)
    local rayDirection = Vector3.new(0, -200, 0)
    local raycastResult = workspace:Raycast(rayOrigin, rayDirection, raycastParams)
    
    if raycastResult then
        return raycastResult.Position.Y
    end
    
    return 0
end

-- IMPROVED: Enable Flying Mode with No-Clip
local function enableFlyingMode(character)
    if not character then return end
    
    -- Remove collision from all parts (No-Clip)
    for _, part in pairs(character:GetDescendants()) do
        if part:IsA("BasePart") then
            part.CanCollide = false
        end
    end
    
    local humanoidRootPart = character:FindFirstChild("HumanoidRootPart")
    if humanoidRootPart then
        -- Clean up old movers
        if bodyVelocity then bodyVelocity:Destroy() end
        if bodyGyro then bodyGyro:Destroy() end
        if antiGravity then antiGravity:Destroy() end
        
        -- Create BodyVelocity for movement
        bodyVelocity = Instance.new("BodyVelocity")
        bodyVelocity.Name = "FollowBodyVelocity"
        bodyVelocity.MaxForce = Vector3.new(40000, 40000, 40000) -- Force in all directions
        bodyVelocity.P = 8000 -- Stronger for better control
        bodyVelocity.Velocity = Vector3.new(0, 0, 0)
        bodyVelocity.Parent = humanoidRootPart
        
        -- Create BodyGyro for stability
        bodyGyro = Instance.new("BodyGyro")
        bodyGyro.Name = "FollowBodyGyro"
        bodyGyro.MaxTorque = Vector3.new(40000, 40000, 40000)
        bodyGyro.P = 5000
        bodyGyro.D = 800
        bodyGyro.CFrame = humanoidRootPart.CFrame
        bodyGyro.Parent = humanoidRootPart
        
        -- Create BodyPosition for height control (better than BodyForce)
        local bodyPosition = Instance.new("BodyPosition")
        bodyPosition.Name = "FollowBodyPosition"
        bodyPosition.MaxForce = Vector3.new(0, 40000, 0)
        bodyPosition.P = 10000
        bodyPosition.D = 1000
        bodyPosition.Position = humanoidRootPart.Position
        bodyPosition.Parent = humanoidRootPart
        
        -- Create BodyForce for anti-gravity
        antiGravity = Instance.new("BodyForce")
        antiGravity.Name = "AntiGravityForce"
        antiGravity.Force = Vector3.new(0, character:GetMass() * workspace.Gravity * 0.8, 0) -- 80% gravity
        antiGravity.Parent = humanoidRootPart
    end
    
    StatusLabel.Text = "Status: Flying & No-Clip ON"
    InfoLabel.Text = string.format("Mode: Flying (No-Clip)\nDistance: %d | Height: %d", targetDistance, followHeight)
end

-- Disable Flying Mode
local function disableFlyingMode(character)
    if not character then return end
    
    -- Restore collision
    for _, part in pairs(character:GetDescendants()) do
        if part:IsA("BasePart") then
            part.CanCollide = true
        end
    end
    
    -- Remove movement controllers
    if bodyVelocity then
        bodyVelocity:Destroy()
        bodyVelocity = nil
    end
    
    if bodyGyro then
        bodyGyro:Destroy()
        bodyGyro = nil
    end
    
    if antiGravity then
        antiGravity:Destroy()
        antiGravity = nil
    end
    
    -- Remove BodyPosition
    local humanoidRootPart = character:FindFirstChild("HumanoidRootPart")
    if humanoidRootPart then
        local bodyPosition = humanoidRootPart:FindFirstChild("FollowBodyPosition")
        if bodyPosition then
            bodyPosition:Destroy()
        end
    end
    
    InfoLabel.Text = string.format("Mode: Ground Follow\nDistance: %d | Height: %d", targetDistance, followHeight)
end

-- IMPROVED: Get target's primary part with BETTER vehicle detection
local function getTargetPrimaryPart(character)
    if not character then return nil, "unknown" end
    
    local humanoid = character:FindFirstChildOfClass("Humanoid")
    local isInVehicle = false
    local vehiclePart = nil
    
    -- Check if humanoid is in a vehicle seat
    if humanoid and humanoid.SeatPart then
        isInVehicle = true
        vehiclePart = humanoid.SeatPart
        
        -- Get the vehicle model (could be the seat's parent or the seat itself)
        local vehicle = vehiclePart.Parent
        
        -- Look for common vehicle root parts in order of preference
        local possibleRoots = {
            vehicle:FindFirstChild("AssemblyRootPart"),
            vehicle:FindFirstChild("VehicleSeat"),
            vehicle:FindFirstChild("Seat"),
            vehicle.PrimaryPart,
            vehiclePart -- Fallback to the seat itself
        }
        
        for _, root in ipairs(possibleRoots) do
            if root and root:IsA("BasePart") then
                return root, "vehicle"
            end
        end
        
        -- If no root found but we have a seat, return the seat
        return vehiclePart, "vehicle"
    end
    
    -- Check for other vehicle indicators (VehicleController, VehicleSeat without humanoid)
    if not isInVehicle then
        -- Look for VehicleSeat that might have the player sitting but no humanoid
        for _, part in pairs(character:GetChildren()) do
            if part:IsA("VehicleSeat") or (part:IsA("Seat") and part:FindFirstChild("Occupant")) then
                isInVehicle = true
                return part, "vehicle"
            end
        end
    end
    
    -- If no vehicle found, use humanoid parts
    local rootPart = character:FindFirstChild("HumanoidRootPart")
    if rootPart then return rootPart, "humanoid" end
    
    local torso = character:FindFirstChild("Torso") or character:FindFirstChild("UpperTorso")
    if torso then return torso, "humanoid" end
    
    for _, part in pairs(character:GetChildren()) do
        if part:IsA("BasePart") then
            return part, "humanoid"
        end
    end
    
    return nil, "unknown"
end

-- Calculate dynamic follow speed with smooth transitions
local function calculateDynamicSpeed(targetVelocity, targetType, targetDistance)
    local baseSpeed = 30
    local velocityMagnitude = targetVelocity.Magnitude
    
    -- Adjust base speed based on target type
    if targetType == "vehicle" then
        baseSpeed = 50 -- Faster for vehicles
    end
    
    -- Add target's velocity to our speed
    local additionalSpeed = velocityMagnitude * 1.5
    
    -- Adjust speed based on distance
    local distanceFactor = math.clamp(targetDistance / 10, 0.5, 2.0)
    
    -- Limit maximum speed
    local calculatedSpeed = math.min(baseSpeed + additionalSpeed, maxFollowSpeed) * distanceFactor
    
    -- Smooth speed transition with type awareness
    if currentSpeed == 0 then
        currentSpeed = calculatedSpeed
    else
        -- If target type changed, adjust speed more quickly
        if targetType ~= lastTargetType then
            smoothness = 0.3 -- Faster adjustment for type change
        else
            smoothness = 0.1 -- Normal smoothness
        end
        
        currentSpeed = currentSpeed + (calculatedSpeed - currentSpeed) * smoothness
    end
    
    lastTargetType = targetType
    return currentSpeed
end

-- Calculate predictive offset with smoothing
local function calculatePredictiveOffset(targetVelocity, deltaTime, targetType)
    -- Predict where target will be based on current velocity
    local lookAheadTime = targetType == "vehicle" and 0.4 or 0.3 -- Longer prediction for vehicles
    
    local prediction = targetVelocity * lookAheadTime
    
    -- Clamp prediction to reasonable distance
    local maxPrediction = targetType == "vehicle" and 25 or 20
    if prediction.Magnitude > maxPrediction then
        prediction = prediction.Unit * maxPrediction
    end
    
    -- Smoothly transition to new prediction
    local transitionSpeed = targetType == "vehicle" and 0.15 or 0.1
    predictiveOffset = predictiveOffset + (prediction - predictiveOffset) * transitionSpeed
    
    return predictiveOffset
end

-- SMART stick follow function with improved vehicle handling
local function smartStickFollow()
    if not sticking then return end
    if not selectedPlayer then 
        unstickFromPlayer()
        return 
    end
    
    local character = LocalPlayer.Character
    local targetCharacter = selectedPlayer.Character
    
    if not character or not targetCharacter then 
        StatusLabel.Text = "Status: Character missing"
        return 
    end
    
    local rootPart = character:FindFirstChild("HumanoidRootPart")
    local targetPrimary, targetType = getTargetPrimaryPart(targetCharacter)
    
    if not rootPart or not targetPrimary then 
        StatusLabel.Text = "Status: Cannot find target"
        return 
    end
    
    local currentTargetPosition = targetPrimary.Position
    local deltaTime = RunService.Heartbeat:Wait()
    
    -- Calculate target velocity with smoothing
    if lastTargetPosition then
        local positionDelta = currentTargetPosition - lastTargetPosition
        local newVelocity = positionDelta / deltaTime
        
        -- Smooth velocity changes
        targetVelocity = targetVelocity:Lerp(newVelocity, 0.3)
    end
    lastTargetPosition = currentTargetPosition
    
    local speed = calculateDynamicSpeed(targetVelocity, targetType, targetDistance)
    local prediction = calculatePredictiveOffset(targetVelocity, deltaTime, targetType)
    
    local targetCFrame = targetPrimary.CFrame
    
    -- Adjust parameters based on target type
    local adjustedHeight = followHeight
    local adjustedDistance = targetDistance
    
    if targetType == "vehicle" then
        -- Vehicles: Higher and slightly further away
        adjustedHeight = followHeight + 2
        adjustedDistance = targetDistance + 2
    end
    
    local baseOffset = Vector3.new(0, adjustedHeight, -adjustedDistance)
    local desiredLocalPosition = baseOffset + prediction
    local desiredWorldPosition = targetCFrame:PointToWorldSpace(desiredLocalPosition)
    
    -- Enhanced anti-baseplate protection
    local targetGroundHeight = getGroundHeight(currentTargetPosition)
    local ourGroundHeight = getGroundHeight(desiredWorldPosition)
    
    -- Find highest ground point
    local highestGround = math.max(targetGroundHeight, ourGroundHeight)
    local minSafeHeight = highestGround + adjustedHeight + 2 -- Extra safety margin
    
    -- If target is flying/falling, adjust to their height
    if currentTargetPosition.Y > targetGroundHeight + 10 then
        minSafeHeight = math.max(minSafeHeight, currentTargetPosition.Y + adjustedHeight - 5)
    end
    
    -- Ensure we never go too low
    local absoluteMinHeight = 5 -- Baseplate level + 5 studs
    minSafeHeight = math.max(minSafeHeight, absoluteMinHeight)
    
    if desiredWorldPosition.Y < minSafeHeight then
        desiredWorldPosition = Vector3.new(
            desiredWorldPosition.X,
            minSafeHeight,
            desiredWorldPosition.Z
        )
    end
    
    -- Calculate direction to desired position
    local direction = desiredWorldPosition - rootPart.Position
    local distance = direction.Magnitude
    
    -- Adjust vertical position smoothly using BodyPosition
    local humanoidRootPart = character:FindFirstChild("HumanoidRootPart")
    if humanoidRootPart then
        local bodyPosition = humanoidRootPart:FindFirstChild("FollowBodyPosition")
        if bodyPosition then
            -- Only adjust Y position, X and Z are handled by BodyVelocity
            local targetYPosition = desiredWorldPosition.Y
            local currentYPosition = humanoidRootPart.Position.Y
            local yDifference = targetYPosition - currentYPosition
            
            -- Smooth vertical movement
            if math.abs(yDifference) > 0.5 then
                local verticalSpeed = math.clamp(yDifference * 2, -15, 15)
                bodyPosition.Position = Vector3.new(
                    humanoidRootPart.Position.X,
                    humanoidRootPart.Position.Y + verticalSpeed * deltaTime,
                    humanoidRootPart.Position.Z
                )
            end
        end
    end
    
    -- Calculate horizontal movement
    local horizontalDirection = Vector3.new(direction.X, 0, direction.Z)
    local horizontalDistance = horizontalDirection.Magnitude
    
    -- Adaptive speed based on distance
    local adaptiveSpeed = speed
    if horizontalDistance < adjustedDistance * 0.3 then
        adaptiveSpeed = speed * 0.3 -- Slow down when very close
    elseif horizontalDistance < adjustedDistance then
        adaptiveSpeed = speed * (horizontalDistance / adjustedDistance) -- Scale speed with distance
    elseif horizontalDistance > adjustedDistance * 2 then
        adaptiveSpeed = speed * 1.5 -- Speed up if far away
    end
    
    adaptiveSpeed = math.clamp(adaptiveSpeed, 5, maxFollowSpeed)
    
    -- Apply horizontal movement
    if horizontalDistance > 0.5 then
        local velocityDirection = horizontalDirection.Unit
        
        -- Anti-overshoot damping
        if horizontalDistance < 3 then
            local dampingFactor = horizontalDistance / 3
            adaptiveSpeed = adaptiveSpeed * dampingFactor
        end
        
        local desiredVelocity = velocityDirection * adaptiveSpeed
        
        if bodyVelocity then
            bodyVelocity.Velocity = Vector3.new(desiredVelocity.X, 0, desiredVelocity.Z)
        end
        
        -- Face the target (horizontal only)
        if bodyGyro then
            local lookAtPosition = Vector3.new(targetPrimary.Position.X, rootPart.Position.Y, targetPrimary.Position.Z)
            local lookAtCFrame = CFrame.new(rootPart.Position, lookAtPosition)
            bodyGyro.CFrame = lookAtCFrame
        end
    else
        -- Maintain position
        if bodyVelocity then
            bodyVelocity.Velocity = Vector3.new(0, 0, 0)
        end
    end
    
    -- Update display
    local statusType = targetType == "vehicle" and "VEHICLE" or "PERSON"
    InfoLabel.Text = string.format("Mode: Flying (No-Clip)\nFollowing: %s | Distance: %d", statusType, targetDistance)
    
    StatusLabel.Text = string.format("Status: STICKING (%s)\nHoriz. Distance: %.1f | Speed: %.1f", 
        selectedPlayer.DisplayName, horizontalDistance, adaptiveSpeed)
    StatusLabel.TextColor3 = Color3.fromRGB(100, 255, 100)
end

-- Start sticking to player with teleport
local function stickToPlayer()
    if sticking then 
        StatusLabel.Text = "Status: Already sticking!"
        StatusLabel.TextColor3 = Color3.fromRGB(255, 200, 100)
        return 
    end
    
    if not selectedPlayer then 
        StatusLabel.Text = "Status: Select a player first!"
        StatusLabel.TextColor3 = Color3.fromRGB(255, 150, 150)
        return 
    end
    
    StatusLabel.Text = "Status: Initializing..."
    StatusLabel.TextColor3 = Color3.fromRGB(255, 200, 100)
    
    local character = LocalPlayer.Character
    if not character then
        character = LocalPlayer.CharacterAdded:Wait()
        task.wait(0.5)
    end
    
    local targetCharacter = selectedPlayer.Character
    if not targetCharacter then
        StatusLabel.Text = "Status: Target has no character"
        StatusLabel.TextColor3 = Color3.fromRGB(255, 150, 150)
        return
    end
    
    local targetPrimary, targetType = getTargetPrimaryPart(targetCharacter)
    if not targetPrimary then
        StatusLabel.Text = "Status: Cannot find target body"
        StatusLabel.TextColor3 = Color3.fromRGB(255, 150, 150)
        return
    end
    
    -- TELEPORT to target first
    StatusLabel.Text = "Status: Teleporting..."
    StatusLabel.TextColor3 = Color3.fromRGB(100, 200, 255)
    
    local rootPart = character:FindFirstChild("HumanoidRootPart")
    if rootPart then
        -- Calculate teleport position (behind target at current settings)
        local teleportOffset = CFrame.new(0, followHeight, -targetDistance)
        local teleportPosition = targetPrimary.CFrame:ToWorldSpace(teleportOffset).Position
        
        -- Ensure we're above ground
        local groundHeight = getGroundHeight(teleportPosition)
        if teleportPosition.Y < groundHeight + 5 then
            teleportPosition = Vector3.new(teleportPosition.X, groundHeight + 5, teleportPosition.Z)
        end
        
        -- Teleport
        character:PivotTo(CFrame.new(teleportPosition))
        task.wait(0.1)
    end
    
    -- Enable flying mode (No-Clip)
    enableFlyingMode(character)
    
    sticking = true
    lastTargetPosition = nil
    predictiveOffset = Vector3.new(0, 0, 0)
    currentSpeed = 0
    
    if stickConnection then
        stickConnection:Disconnect()
    end
    
    stickConnection = RunService.Heartbeat:Connect(function()
        smartStickFollow()
    end)
    
    StickButton.BackgroundColor3 = Color3.fromRGB(30, 150, 50)
    UnstickButton.BackgroundColor3 = Color3.fromRGB(180, 60, 60)
    
    StatusLabel.Text = "Status: STICKING ACTIVE"
    StatusLabel.TextColor3 = Color3.fromRGB(100, 255, 100)
end

-- Stop sticking to player
local function unstickFromPlayer()
    sticking = false
    currentSpeed = 0
    
    if stickConnection then
        stickConnection:Disconnect()
        stickConnection = nil
    end
    
    local character = LocalPlayer.Character
    if character then
        disableFlyingMode(character)
    end
    
    StickButton.BackgroundColor3 = Color3.fromRGB(50, 180, 70)
    UnstickButton.BackgroundColor3 = Color3.fromRGB(180, 60, 60)
    
    StatusLabel.Text = "Status: Idle"
    StatusLabel.TextColor3 = Color3.fromRGB(150, 200, 150)
    InfoLabel.Text = string.format("Mode: Ground Follow\nDistance: %d | Height: %d", targetDistance, followHeight)
end

-- Update player list with search - CLEARLY SHOW BOTH NAMES
local function updatePlayerList()
    for _, button in pairs(playerButtons) do
        button:Destroy()
    end
    playerButtons = {}
    
    for _, player in pairs(Players:GetPlayers()) do
        if player ~= LocalPlayer then
            if searchFilter == "" or 
               string.find(string.lower(player.Name), string.lower(searchFilter)) or
               string.find(string.lower(player.DisplayName), string.lower(searchFilter)) then
                
                local button = TemplateButton:Clone()
                button.Name = "PlayerButton_" .. player.Name
                button.Visible = true
                button.BackgroundColor3 = selectedPlayer == player and Color3.fromRGB(80, 120, 200) or Color3.fromRGB(50, 50, 55)
                button.Parent = PlayerListFrame
                table.insert(playerButtons, button)
                
                -- Username Container
                local usernameContainer = Instance.new("Frame")
                usernameContainer.Size = UDim2.new(1, -10, 0, 25)
                usernameContainer.Position = UDim2.new(0, 5, 0, 5)
                usernameContainer.BackgroundTransparency = 1
                usernameContainer.Parent = button
                
                local usernameLabel = Instance.new("TextLabel")
                usernameLabel.Size = UDim2.new(0.4, 0, 1, 0)
                usernameLabel.Position = UDim2.new(0, 0, 0, 0)
                usernameLabel.BackgroundTransparency = 1
                usernameLabel.Text = "Username:"
                usernameLabel.TextColor3 = Color3.fromRGB(180, 180, 180)
                usernameLabel.Font = Enum.Font.Gotham
                usernameLabel.TextSize = 11
                usernameLabel.TextXAlignment = Enum.TextXAlignment.Left
                usernameLabel.Parent = usernameContainer
                
                local usernameValue = Instance.new("TextLabel")
                usernameValue.Size = UDim2.new(0.6, 0, 1, 0)
                usernameValue.Position = UDim2.new(0.4, 0, 0, 0)
                usernameValue.BackgroundTransparency = 1
                usernameValue.Text = player.Name
                usernameValue.TextColor3 = Color3.fromRGB(180, 180, 255)
                usernameValue.Font = Enum.Font.GothamBold
                usernameValue.TextSize = 12
                usernameValue.TextXAlignment = Enum.TextXAlignment.Left
                usernameValue.TextTruncate = Enum.TextTruncate.AtEnd
                usernameValue.Parent = usernameContainer
                
                -- Display Name Container
                local displayNameContainer = Instance.new("Frame")
                displayNameContainer.Size = UDim2.new(1, -10, 0, 25)
                displayNameContainer.Position = UDim2.new(0, 5, 0, 30)
                displayNameContainer.BackgroundTransparency = 1
                displayNameContainer.Parent = button
                
                local displayNameLabel = Instance.new("TextLabel")
                displayNameLabel.Size = UDim2.new(0.4, 0, 1, 0)
                displayNameLabel.Position = UDim2.new(0, 0, 0, 0)
                displayNameLabel.BackgroundTransparency = 1
                displayNameLabel.Text = "Nickname:"
                displayNameLabel.TextColor3 = Color3.fromRGB(180, 180, 180)
                displayNameLabel.Font = Enum.Font.Gotham
                displayNameLabel.TextSize = 11
                displayNameLabel.TextXAlignment = Enum.TextXAlignment.Left
                displayNameLabel.Parent = displayNameContainer
                
                local displayNameValue = Instance.new("TextLabel")
                displayNameValue.Size = UDim2.new(0.6, 0, 1, 0)
                displayNameValue.Position = UDim2.new(0.4, 0, 0, 0)
                displayNameValue.BackgroundTransparency = 1
                displayNameValue.Text = player.DisplayName
                displayNameValue.TextColor3 = Color3.fromRGB(255, 180, 180)
                displayNameValue.Font = Enum.Font.GothamBold
                displayNameValue.TextSize = 12
                displayNameValue.TextXAlignment = Enum.TextXAlignment.Left
                displayNameValue.TextTruncate = Enum.TextTruncate.AtEnd
                displayNameValue.Parent = displayNameContainer
                
                -- Vehicle indicator
                local vehicleIndicator = Instance.new("Frame")
                vehicleIndicator.Size = UDim2.new(0, 10, 0, 10)
                vehicleIndicator.Position = UDim2.new(1, -15, 0.5, -5)
                vehicleIndicator.BackgroundColor3 = Color3.fromRGB(100, 100, 100)
                vehicleIndicator.BorderSizePixel = 0
                vehicleIndicator.Parent = button
                
                local indicatorLabel = Instance.new("TextLabel")
                indicatorLabel.Size = UDim2.new(1, 0, 1, 0)
                indicatorLabel.BackgroundTransparency = 1
                indicatorLabel.Text = "V"
                indicatorLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
                indicatorLabel.Font = Enum.Font.GothamBold
                indicatorLabel.TextSize = 8
                indicatorLabel.Parent = vehicleIndicator
                
                -- Monitor player's vehicle status
                local function updateIndicator()
                    if player.Character then
                        local _, targetType = getTargetPrimaryPart(player.Character)
                        if targetType == "vehicle" then
                            vehicleIndicator.BackgroundColor3 = Color3.fromRGB(0, 200, 255)
                            indicatorLabel.Text = "V"
                        else
                            vehicleIndicator.BackgroundColor3 = Color3.fromRGB(100, 100, 100)
                            indicatorLabel.Text = "P"
                        end
                    end
                end
                
                player.CharacterAdded:Connect(updateIndicator)
                if player.Character then
                    updateIndicator()
                end
                
                if selectedPlayer == player then
                    lastHighlight = button
                end
                
                button.MouseButton1Click:Connect(function()
                    if lastHighlight then
                        lastHighlight.BackgroundColor3 = Color3.fromRGB(50, 50, 55)
                    end
                    
                    selectedPlayer = player
                    lastHighlight = button
                    button.BackgroundColor3 = Color3.fromRGB(80, 120, 200)
                    
                    -- Update selected player display with both names
                    SelectedPlayerLabel.Text = string.format("Selected Player:\nUsername: %s\nNickname: %s", 
                        player.Name, player.DisplayName)
                    StatusLabel.Text = "Status: Ready to stick"
                    StatusLabel.TextColor3 = Color3.fromRGB(150, 200, 150)
                    
                    -- Update vehicle status
                    if player.Character then
                        local _, targetType = getTargetPrimaryPart(player.Character)
                        local statusText = targetType == "vehicle" and "In Vehicle" or "On Foot"
                        StatusLabel.Text = string.format("Status: Ready (%s)", statusText)
                    end
                end)
            end
        end
    end
end

-- Handle player leaving
local function handlePlayerLeaving(player)
    if player == selectedPlayer then
        selectedPlayer = nil
        if lastHighlight then
            lastHighlight.BackgroundColor3 = Color3.fromRGB(50, 50, 55)
            lastHighlight = nil
        end
        SelectedPlayerLabel.Text = "Selected: None"
        unstickFromPlayer()
        StatusLabel.Text = "Status: Player left game"
        StatusLabel.TextColor3 = Color3.fromRGB(255, 150, 150)
        
        task.delay(3, function()
            if StatusLabel.Text == "Status: Player left game" then
                StatusLabel.Text = "Status: Idle"
                StatusLabel.TextColor3 = Color3.fromRGB(150, 200, 150)
            end
        end)
    end
    task.wait(0.5)
    updatePlayerList()
end

-- Handle player joining
local function handlePlayerJoining(player)
    task.wait(0.5)
    updatePlayerList()
    
    StatusLabel.Text = string.format("Status: %s (%s) joined", player.DisplayName, player.Name)
    StatusLabel.TextColor3 = Color3.fromRGB(150, 200, 255)
    task.wait(2)
    if StatusLabel.Text == string.format("Status: %s (%s) joined", player.DisplayName, player.Name) then
        StatusLabel.Text = "Status: Idle"
        StatusLabel.TextColor3 = Color3.fromRGB(150, 200, 150)
    end
end

-- HIDE/SHOW FUNCTIONS
local function hideGUI()
    MainFrame.Visible = false
    UnhideButton.Visible = true
    UnhideButton.Position = MainFrame.Position
end

local function showGUI()
    MainFrame.Visible = true
    UnhideButton.Visible = false
end

-- Update distance and height displays
local function updateSettingsDisplay()
    DistanceValue.Text = tostring(targetDistance)
    HeightValue.Text = tostring(followHeight)
    InfoLabel.Text = string.format("Mode: Floating Follow\nDistance: %d | Height: %d", targetDistance, followHeight)
end

-- Distance controls
DistanceMinus.MouseButton1Click:Connect(function()
    targetDistance = math.max(2, targetDistance - 1)
    updateSettingsDisplay()
end)

DistancePlus.MouseButton1Click:Connect(function()
    targetDistance = math.min(30, targetDistance + 1) -- Increased max distance
    updateSettingsDisplay()
end)

-- Height controls
HeightMinus.MouseButton1Click:Connect(function()
    followHeight = math.max(2, followHeight - 1)
    updateSettingsDisplay()
end)

HeightPlus.MouseButton1Click:Connect(function()
    followHeight = math.min(15, followHeight + 1) -- Increased max height
    updateSettingsDisplay()
end)

-- Make GUI draggable
makeDraggableTouch(MainFrame, DragArea)
makeDraggableTouch(UnhideButton, UnhideButton)

-- Hide button functionality
HideButton.MouseButton1Click:Connect(function()
    hideGUI()
end)

-- Unhide button functionality
UnhideButton.MouseButton1Click:Connect(function()
    showGUI()
end)

-- Search functionality
SearchBox:GetPropertyChangedSignal("Text"):Connect(function()
    searchFilter = SearchBox.Text
    updatePlayerList()
end)

-- Stick button
StickButton.MouseButton1Click:Connect(function()
    if selectedPlayer then
        StickButton.BackgroundColor3 = Color3.fromRGB(30, 130, 50)
        task.spawn(stickToPlayer)
        task.wait(0.1)
        StickButton.BackgroundColor3 = sticking and Color3.fromRGB(30, 150, 50) or Color3.fromRGB(50, 180, 70)
    else
        StatusLabel.Text = "Status: SELECT A PLAYER FIRST!"
        StatusLabel.TextColor3 = Color3.fromRGB(255, 150, 150)
        task.wait(2)
        if StatusLabel.Text == "Status: SELECT A PLAYER FIRST!" then
            StatusLabel.Text = "Status: Idle"
            StatusLabel.TextColor3 = Color3.fromRGB(150, 200, 150)
        end
    end
end)

-- Unstick button
UnstickButton.MouseButton1Click:Connect(unstickFromPlayer)

-- Close button destroys the GUI
CloseButton.MouseButton1Click:Connect(function() 
    unstickFromPlayer()
    ScreenGui:Destroy() 
end)

-- Initial setup
updatePlayerList()
updateSettingsDisplay()

-- Auto-refresh player list
task.spawn(function()
    while ScreenGui.Parent and ScreenGui.Parent == PlayerGui do
        updatePlayerList()
        task.wait(2)
    end
end)

-- Connect player events
Players.PlayerAdded:Connect(handlePlayerJoining)
Players.PlayerRemoving:Connect(handlePlayerLeaving)

-- Auto-unstick when character respawns
LocalPlayer.CharacterAdded:Connect(function(character)
    unstickFromPlayer()
    task.wait(1)
    local humanoid = character:FindFirstChildOfClass("Humanoid")
    if humanoid then
        humanoid.Died:Connect(function()
            unstickFromPlayer()
        end)
    end
end)

-- Handle initial character death
if LocalPlayer.Character then
    local humanoid = LocalPlayer.Character:FindFirstChildOfClass("Humanoid")
    if humanoid then
        humanoid.Died:Connect(function()
            unstickFromPlayer()
        end)
    end
end
