-- COMPLETE MOBILE-FRIENDLY SMART FOLLOW SYSTEM
-- Combines advanced follow logic with modern mobile GUI

-- Services
local Players = game:GetService("Players")
local RunService = game:GetService("RunService")
local UserInputService = game:GetService("UserInputService")
local TweenService = game:GetService("TweenService")

-- Player variables
local LocalPlayer = Players.LocalPlayer
local CurrentTarget = nil
local Following = false
local FollowDistance = 3
local FollowHeight = 4
local CurrentFlySpeed = 0
local MaxFlySpeed = 300
local Method = "Smart Follow"
local PhysicsFrameId = 0

-- Player nickname system
local PlayerNicknames = {}
local SelectedPlayerButton = nil

-- GUI State
local GuiVisible = true
local Dragging = false
local DragStartPosition
local GuiStartPosition

-- ADVANCED FOLLOW SYSTEM VARIABLES
local PhysicsRoot = nil
local PhysicsRootId = nil
local LastRootCFrame = nil
local LastRootVelocity = Vector3.new(0, 0, 0)
local ReferenceOffset = Vector3.new(0, 0, 0)
local IsPhysicsLocked = false
local LastLockTime = 0
local StabilityScore = 0
local AssemblyChangeDetected = false

-- Performance tracking
local SpeedHistory = {}
local AccelerationHistory = {}
local JerkHistory = {}
local PhysicsStateHistory = {}
local MAX_HISTORY = 5

-- Constants for validation
local MAX_VALID_DELTA = 1000 -- studs per frame
local MAX_VALID_SPEED = 5000 -- studs/sec
local STABILITY_THRESHOLD = 5 -- frames of stability required
local REBIND_COOLDOWN = 0.1 -- seconds between rebinds

-- Colors for theme
local ColorPalette = {
    Background = Color3.fromRGB(25, 25, 35),
    BackgroundLight = Color3.fromRGB(35, 35, 45),
    BackgroundDark = Color3.fromRGB(15, 15, 25),
    Primary = Color3.fromRGB(0, 170, 255),
    PrimaryDark = Color3.fromRGB(0, 140, 225),
    Secondary = Color3.fromRGB(255, 85, 0),
    SecondaryDark = Color3.fromRGB(225, 65, 0),
    Text = Color3.fromRGB(240, 240, 240),
    TextMuted = Color3.fromRGB(180, 180, 180),
    Success = Color3.fromRGB(0, 200, 100),
    Warning = Color3.fromRGB(255, 165, 0),
    Danger = Color3.fromRGB(255, 60, 60),
    Selected = Color3.fromRGB(50, 150, 255),
    ButtonNormal = Color3.fromRGB(50, 50, 70),
    ButtonPressed = Color3.fromRGB(70, 70, 90)
}

-- ===================== CREATE MOD MENU GUI =====================
local ScreenGui = Instance.new("ScreenGui")
ScreenGui.Name = "SmartFollowGUI"
ScreenGui.ResetOnSpawn = false
ScreenGui.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
ScreenGui.IgnoreGuiInset = false

-- Main container frame - MOD MENU SIZE
local MainFrame = Instance.new("Frame")
MainFrame.Name = "MainFrame"
MainFrame.Size = UDim2.new(0.45, 0, 0.6, 0)  -- Proper mod menu size
MainFrame.Position = UDim2.new(0.02, 0, 0.2, 0)
MainFrame.BackgroundColor3 = ColorPalette.Background
MainFrame.BorderSizePixel = 0
MainFrame.ClipsDescendants = true

local MainCorner = Instance.new("UICorner")
MainCorner.CornerRadius = UDim.new(0, 12)
MainCorner.Parent = MainFrame

-- Title Bar
local TitleBar = Instance.new("Frame")
TitleBar.Name = "TitleBar"
TitleBar.Size = UDim2.new(1, 0, 0, 40)
TitleBar.BackgroundColor3 = ColorPalette.BackgroundLight
TitleBar.BorderSizePixel = 0

local TitleBarCorner = Instance.new("UICorner")
TitleBarCorner.CornerRadius = UDim.new(0, 12)
TitleBarCorner.Parent = TitleBar

-- Title
local Title = Instance.new("TextLabel")
Title.Name = "Title"
Title.Size = UDim2.new(0.7, 0, 1, 0)
Title.Position = UDim2.new(0, 15, 0, 0)
Title.BackgroundTransparency = 1
Title.Text = "FOLLOW SYSTEM"
Title.TextColor3 = ColorPalette.Primary
Title.TextSize = 18
Title.Font = Enum.Font.GothamBold
Title.TextXAlignment = Enum.TextXAlignment.Left
Title.TextYAlignment = Enum.TextYAlignment.Center
Title.Parent = TitleBar

-- Close button
local CloseButton = Instance.new("TextButton")
CloseButton.Name = "CloseButton"
CloseButton.Size = UDim2.new(0, 30, 0, 30)
CloseButton.Position = UDim2.new(1, -35, 0, 5)
CloseButton.BackgroundColor3 = ColorPalette.Danger
CloseButton.Text = "âœ•"
CloseButton.TextColor3 = Color3.new(1, 1, 1)
CloseButton.TextSize = 16
CloseButton.Font = Enum.Font.GothamBold
CloseButton.TextYAlignment = Enum.TextYAlignment.Center

local CloseCorner = Instance.new("UICorner")
CloseCorner.CornerRadius = UDim.new(0, 8)
CloseCorner.Parent = CloseButton

CloseButton.Parent = TitleBar
TitleBar.Parent = MainFrame

-- Main content
local MainContent = Instance.new("Frame")
MainContent.Name = "MainContent"
MainContent.Size = UDim2.new(1, 0, 1, -40)
MainContent.Position = UDim2.new(0, 0, 0, 40)
MainContent.BackgroundTransparency = 1
MainContent.Parent = MainFrame

local ContentPadding = Instance.new("UIPadding")
ContentPadding.PaddingLeft = UDim.new(0, 12)
ContentPadding.PaddingRight = UDim.new(0, 12)
ContentPadding.PaddingTop = UDim.new(0, 12)
ContentPadding.PaddingBottom = UDim.new(0, 12)
ContentPadding.Parent = MainContent

-- Player list section (always visible)
local PlayerListSection = Instance.new("Frame")
PlayerListSection.Name = "PlayerListSection"
PlayerListSection.Size = UDim2.new(1, 0, 0.45, 0)
PlayerListSection.BackgroundColor3 = ColorPalette.BackgroundLight
PlayerListSection.BorderSizePixel = 0

local PlayerListCorner = Instance.new("UICorner")
PlayerListCorner.CornerRadius = UDim.new(0, 8)
PlayerListCorner.Parent = PlayerListSection

local PlayerListTitle = Instance.new("TextLabel")
PlayerListTitle.Name = "PlayerListTitle"
PlayerListTitle.Size = UDim2.new(1, 0, 0, 30)
PlayerListTitle.BackgroundTransparency = 1
PlayerListTitle.Text = "ðŸ‘¥ PLAYER LIST"
PlayerListTitle.TextColor3 = ColorPalette.Text
PlayerListTitle.TextSize = 14
PlayerListTitle.Font = Enum.Font.GothamBold
PlayerListTitle.TextXAlignment = Enum.TextXAlignment.Left
PlayerListTitle.TextYAlignment = Enum.TextYAlignment.Center
PlayerListTitle.Parent = PlayerListSection

local PlayerListContainer = Instance.new("ScrollingFrame")
PlayerListContainer.Name = "PlayerListContainer"
PlayerListContainer.Size = UDim2.new(1, -10, 1, -40)
PlayerListContainer.Position = UDim2.new(0, 5, 0, 35)
PlayerListContainer.BackgroundTransparency = 1
PlayerListContainer.BorderSizePixel = 0
PlayerListContainer.ScrollBarThickness = 6
PlayerListContainer.ScrollBarImageColor3 = ColorPalette.BackgroundDark
PlayerListContainer.CanvasSize = UDim2.new(0, 0, 0, 0)
PlayerListContainer.AutomaticCanvasSize = Enum.AutomaticSize.Y

local PlayerListLayout = Instance.new("UIListLayout")
PlayerListLayout.SortOrder = Enum.SortOrder.Name
PlayerListLayout.Padding = UDim.new(0, 6)
PlayerListLayout.Parent = PlayerListContainer

PlayerListContainer.Parent = PlayerListSection
PlayerListSection.Parent = MainContent

-- Controls section
local ControlsSection = Instance.new("Frame")
ControlsSection.Name = "ControlsSection"
ControlsSection.Size = UDim2.new(1, 0, 0.55, 0)
ControlsSection.Position = UDim2.new(0, 0, 0.47, 0)
ControlsSection.BackgroundTransparency = 1
ControlsSection.Parent = MainContent

-- Selected and Status row
local InfoRow = Instance.new("Frame")
InfoRow.Name = "InfoRow"
InfoRow.Size = UDim2.new(1, 0, 0, 60)
InfoRow.BackgroundTransparency = 1
InfoRow.Parent = ControlsSection

-- Selected display
local SelectedContainer = Instance.new("Frame")
SelectedContainer.Name = "SelectedContainer"
SelectedContainer.Size = UDim2.new(0.48, 0, 1, 0)
SelectedContainer.BackgroundColor3 = ColorPalette.BackgroundDark
SelectedContainer.BorderSizePixel = 0

local SelectedCorner = Instance.new("UICorner")
SelectedCorner.CornerRadius = UDim.new(0, 8)
SelectedCorner.Parent = SelectedContainer

local SelectedLabel = Instance.new("TextLabel")
SelectedLabel.Name = "SelectedLabel"
SelectedLabel.Size = UDim2.new(1, -10, 0.4, 0)
SelectedLabel.Position = UDim2.new(0, 5, 0, 0)
SelectedLabel.BackgroundTransparency = 1
SelectedLabel.Text = "SELECTED"
SelectedLabel.TextColor3 = ColorPalette.TextMuted
SelectedLabel.TextSize = 12
SelectedLabel.Font = Enum.Font.GothamMedium
SelectedLabel.TextXAlignment = Enum.TextXAlignment.Left
SelectedLabel.Parent = SelectedContainer

local SelectedValue = Instance.new("TextLabel")
SelectedValue.Name = "SelectedValue"
SelectedValue.Size = UDim2.new(1, -10, 0.6, 0)
SelectedValue.Position = UDim2.new(0, 5, 0.4, 0)
SelectedValue.BackgroundTransparency = 1
SelectedValue.Text = "None"
SelectedValue.TextColor3 = ColorPalette.Text
SelectedValue.TextSize = 14
SelectedValue.Font = Enum.Font.GothamBold
SelectedValue.TextXAlignment = Enum.TextXAlignment.Left
SelectedValue.Parent = SelectedContainer

SelectedContainer.Parent = InfoRow

-- Status display
local StatusContainer = Instance.new("Frame")
StatusContainer.Name = "StatusContainer"
StatusContainer.Size = UDim2.new(0.48, 0, 1, 0)
StatusContainer.Position = UDim2.new(0.52, 0, 0, 0)
StatusContainer.BackgroundColor3 = ColorPalette.BackgroundDark
StatusContainer.BorderSizePixel = 0

local StatusCorner = Instance.new("UICorner")
StatusCorner.CornerRadius = UDim.new(0, 8)
StatusCorner.Parent = StatusContainer

local StatusLabel = Instance.new("TextLabel")
StatusLabel.Name = "StatusLabel"
StatusLabel.Size = UDim2.new(1, -10, 0.4, 0)
StatusLabel.Position = UDim2.new(0, 5, 0, 0)
StatusLabel.BackgroundTransparency = 1
StatusLabel.Text = "STATUS"
StatusLabel.TextColor3 = ColorPalette.TextMuted
StatusLabel.TextSize = 12
StatusLabel.Font = Enum.Font.GothamMedium
StatusLabel.TextXAlignment = Enum.TextXAlignment.Left
StatusLabel.Parent = StatusContainer

local StatusValue = Instance.new("TextLabel")
StatusValue.Name = "StatusValue"
StatusValue.Size = UDim2.new(1, -10, 0.6, 0)
StatusValue.Position = UDim2.new(0, 5, 0.4, 0)
StatusValue.BackgroundTransparency = 1
StatusValue.Text = "Idle"
StatusValue.TextColor3 = ColorPalette.Text
StatusValue.TextSize = 14
StatusValue.Font = Enum.Font.GothamBold
StatusValue.TextXAlignment = Enum.TextXAlignment.Left
StatusValue.Parent = StatusContainer

StatusContainer.Parent = InfoRow

-- Action buttons
local ButtonRow = Instance.new("Frame")
ButtonRow.Name = "ButtonRow"
ButtonRow.Size = UDim2.new(1, 0, 0, 50)
ButtonRow.Position = UDim2.new(0, 0, 0, 70)
ButtonRow.BackgroundTransparency = 1
ButtonRow.Parent = ControlsSection

local FollowButton = Instance.new("TextButton")
FollowButton.Name = "FollowButton"
FollowButton.Size = UDim2.new(0.32, 0, 1, 0)
FollowButton.BackgroundColor3 = ColorPalette.Success
FollowButton.Text = "FOLLOW"
FollowButton.TextColor3 = Color3.new(1, 1, 1)
FollowButton.TextSize = 14
FollowButton.Font = Enum.Font.GothamBold
FollowButton.TextYAlignment = Enum.TextYAlignment.Center

local FollowCorner = Instance.new("UICorner")
FollowCorner.CornerRadius = UDim.new(0, 8)
FollowCorner.Parent = FollowButton

local TeleportButton = Instance.new("TextButton")
TeleportButton.Name = "TeleportButton"
TeleportButton.Size = UDim2.new(0.32, 0, 1, 0)
TeleportButton.Position = UDim2.new(0.34, 0, 0, 0)
TeleportButton.BackgroundColor3 = ColorPalette.Primary
TeleportButton.Text = "TELEPORT"
TeleportButton.TextColor3 = Color3.new(1, 1, 1)
TeleportButton.TextSize = 14
TeleportButton.Font = Enum.Font.GothamBold
TeleportButton.TextYAlignment = Enum.TextYAlignment.Center

local TeleportCorner = Instance.new("UICorner")
TeleportCorner.CornerRadius = UDim.new(0, 8)
TeleportCorner.Parent = TeleportButton

local UnfollowButton = Instance.new("TextButton")
UnfollowButton.Name = "UnfollowButton"
UnfollowButton.Size = UDim2.new(0.32, 0, 1, 0)
UnfollowButton.Position = UDim2.new(0.68, 0, 0, 0)
UnfollowButton.BackgroundColor3 = ColorPalette.ButtonNormal
UnfollowButton.Text = "STOP"
UnfollowButton.TextColor3 = ColorPalette.Text
UnfollowButton.TextSize = 14
UnfollowButton.Font = Enum.Font.GothamBold
UnfollowButton.TextYAlignment = Enum.TextYAlignment.Center

local UnfollowCorner = Instance.new("UICorner")
UnfollowCorner.CornerRadius = UDim.new(0, 8)
UnfollowCorner.Parent = UnfollowButton

FollowButton.Parent = ButtonRow
TeleportButton.Parent = ButtonRow
UnfollowButton.Parent = ButtonRow

-- Settings row
local SettingsRow = Instance.new("Frame")
SettingsRow.Name = "SettingsRow"
SettingsRow.Size = UDim2.new(1, 0, 0, 70)
SettingsRow.Position = UDim2.new(0, 0, 0, 130)
SettingsRow.BackgroundTransparency = 1
SettingsRow.Parent = ControlsSection

-- Speed control
local SpeedContainer = Instance.new("Frame")
SpeedContainer.Name = "SpeedContainer"
SpeedContainer.Size = UDim2.new(1, 0, 0, 40)
SpeedContainer.BackgroundColor3 = ColorPalette.BackgroundDark
SpeedContainer.BorderSizePixel = 0

local SpeedCorner = Instance.new("UICorner")
SpeedCorner.CornerRadius = UDim.new(0, 8)
SpeedCorner.Parent = SpeedContainer

local SpeedLabel = Instance.new("TextLabel")
SpeedLabel.Name = "SpeedLabel"
SpeedLabel.Size = UDim2.new(0.6, 0, 0.5, 0)
SpeedLabel.Position = UDim2.new(0, 10, 0, 0)
SpeedLabel.BackgroundTransparency = 1
SpeedLabel.Text = "MAX SPEED"
SpeedLabel.TextColor3 = ColorPalette.TextMuted
SpeedLabel.TextSize = 12
SpeedLabel.Font = Enum.Font.GothamMedium
SpeedLabel.TextXAlignment = Enum.TextXAlignment.Left
SpeedLabel.Parent = SpeedContainer

local SpeedValue = Instance.new("TextLabel")
SpeedValue.Name = "SpeedValue"
SpeedValue.Size = UDim2.new(0.6, 0, 0.5, 0)
SpeedValue.Position = UDim2.new(0, 10, 0.5, 0)
SpeedValue.BackgroundTransparency = 1
SpeedValue.Text = "300"
SpeedValue.TextColor3 = ColorPalette.Text
SpeedValue.TextSize = 16
SpeedValue.Font = Enum.Font.GothamBold
SpeedValue.TextXAlignment = Enum.TextXAlignment.Left
SpeedValue.Parent = SpeedContainer

local SpeedMinus = Instance.new("TextButton")
SpeedMinus.Name = "SpeedMinus"
SpeedMinus.Size = UDim2.new(0.15, 0, 0.7, 0)
SpeedMinus.Position = UDim2.new(0.65, 0, 0.15, 0)
SpeedMinus.BackgroundColor3 = ColorPalette.ButtonNormal
SpeedMinus.Text = "-10"
SpeedMinus.TextColor3 = ColorPalette.Text
SpeedMinus.TextSize = 14
SpeedMinus.Font = Enum.Font.GothamBold
SpeedMinus.TextYAlignment = Enum.TextYAlignment.Center

local SpeedMinusCorner = Instance.new("UICorner")
SpeedMinusCorner.CornerRadius = UDim.new(0, 6)
SpeedMinusCorner.Parent = SpeedMinus

local SpeedPlus = Instance.new("TextButton")
SpeedPlus.Name = "SpeedPlus"
SpeedPlus.Size = UDim2.new(0.15, 0, 0.7, 0)
SpeedPlus.Position = UDim2.new(0.82, 0, 0.15, 0)
SpeedPlus.BackgroundColor3 = ColorPalette.ButtonNormal
SpeedPlus.Text = "+10"
SpeedPlus.TextColor3 = ColorPalette.Text
SpeedPlus.TextSize = 14
SpeedPlus.Font = Enum.Font.GothamBold
SpeedPlus.TextYAlignment = Enum.TextYAlignment.Center

local SpeedPlusCorner = Instance.new("UICorner")
SpeedPlusCorner.CornerRadius = UDim.new(0, 6)
SpeedPlusCorner.Parent = SpeedPlus

SpeedMinus.Parent = SpeedContainer
SpeedPlus.Parent = SpeedContainer
SpeedContainer.Parent = SettingsRow

MainFrame.Parent = ScreenGui
ScreenGui.Parent = LocalPlayer:WaitForChild("PlayerGui")

-- ===================== ADVANCED FOLLOW LOGIC =====================

-- Get ALL players in server
local function getAllPlayers()
    local allPlayers = {}
    for _, player in pairs(Players:GetPlayers()) do
        if player ~= LocalPlayer then
            table.insert(allPlayers, player)
        end
    end
    return allPlayers
end

-- Create player entry with nickname
local function createPlayerEntry(player)
    local PlayerEntry = Instance.new("Frame")
    PlayerEntry.Name = player.Name
    PlayerEntry.Size = UDim2.new(1, 0, 0, 50)
    PlayerEntry.BackgroundColor3 = ColorPalette.BackgroundDark
    PlayerEntry.BackgroundTransparency = 0.5
    
    local EntryCorner = Instance.new("UICorner")
    EntryCorner.CornerRadius = UDim.new(0, 8)
    EntryCorner.Parent = PlayerEntry
    
    -- Left side: Player name and username
    local NameContainer = Instance.new("Frame")
    NameContainer.Name = "NameContainer"
    NameContainer.Size = UDim2.new(0.6, 0, 1, 0)
    NameContainer.BackgroundTransparency = 1
    NameContainer.Parent = PlayerEntry
    
    local PlayerNameLabel = Instance.new("TextLabel")
    PlayerNameLabel.Name = "PlayerNameLabel"
    PlayerNameLabel.Size = UDim2.new(1, -10, 0.6, 0)
    PlayerNameLabel.Position = UDim2.new(0, 5, 0.1, 0)
    PlayerNameLabel.BackgroundTransparency = 1
    PlayerNameLabel.Text = PlayerNicknames[player.Name] or player.DisplayName
    PlayerNameLabel.TextColor3 = ColorPalette.Text
    PlayerNameLabel.TextSize = 14
    PlayerNameLabel.Font = Enum.Font.GothamMedium
    PlayerNameLabel.TextXAlignment = Enum.TextXAlignment.Left
    PlayerNameLabel.TextYAlignment = Enum.TextYAlignment.Center
    PlayerNameLabel.TruncateTextOnSizeChange = true
    PlayerNameLabel.Parent = NameContainer
    
    local UserNameLabel = Instance.new("TextLabel")
    UserNameLabel.Name = "UserNameLabel"
    UserNameLabel.Size = UDim2.new(1, -10, 0.4, 0)
    UserNameLabel.Position = UDim2.new(0, 5, 0.6, 0)
    UserNameLabel.BackgroundTransparency = 1
    UserNameLabel.Text = "@" .. player.Name
    UserNameLabel.TextColor3 = ColorPalette.TextMuted
    UserNameLabel.TextSize = 12
    UserNameLabel.Font = Enum.Font.Gotham
    UserNameLabel.TextXAlignment = Enum.TextXAlignment.Left
    UserNameLabel.TextYAlignment = Enum.TextYAlignment.Center
    UserNameLabel.Parent = NameContainer
    
    -- Right side: Nickname input
    local NicknameContainer = Instance.new("Frame")
    NicknameContainer.Name = "NicknameContainer"
    NicknameContainer.Size = UDim2.new(0.4, 0, 1, 0)
    NicknameContainer.Position = UDim2.new(0.6, 0, 0, 0)
    NicknameContainer.BackgroundTransparency = 1
    NicknameContainer.Parent = PlayerEntry
    
    local NicknameBox = Instance.new("TextBox")
    NicknameBox.Name = "NicknameBox"
    NicknameBox.Size = UDim2.new(0.9, 0, 0.5, 0)
    NicknameBox.Position = UDim2.new(0.05, 0, 0.25, 0)
    NicknameBox.BackgroundColor3 = ColorPalette.Background
    NicknameBox.TextColor3 = ColorPalette.Text
    NicknameBox.TextSize = 12
    NicknameBox.Font = Enum.Font.Gotham
    NicknameBox.PlaceholderText = "Nickname"
    NicknameBox.PlaceholderColor3 = ColorPalette.TextMuted
    NicknameBox.Text = PlayerNicknames[player.Name] or ""
    NicknameBox.ClearTextOnFocus = false
    
    local NicknameBoxCorner = Instance.new("UICorner")
    NicknameBoxCorner.CornerRadius = UDim.new(0, 6)
    NicknameBoxCorner.Parent = NicknameBox
    
    NicknameBox.FocusLost:Connect(function()
        local newNickname = NicknameBox.Text:gsub("%s+", " "):gsub("^%s+", ""):gsub("%s+$", "")
        if newNickname == "" then
            PlayerNicknames[player.Name] = nil
            NicknameBox.Text = ""
            PlayerNameLabel.Text = player.DisplayName
        else
            PlayerNicknames[player.Name] = newNickname
            NicknameBox.Text = newNickname
            PlayerNameLabel.Text = newNickname
        end
        
        -- Update selected display if this is the current target
        if CurrentTarget == player then
            SelectedValue.Text = newNickname == "" and player.DisplayName or newNickname
        end
    end)
    
    NicknameBox.Parent = NicknameContainer
    
    -- Touch button for selection
    local TouchButton = Instance.new("TextButton")
    TouchButton.Name = "TouchButton"
    TouchButton.Size = UDim2.new(1, 0, 1, 0)
    TouchButton.BackgroundTransparency = 1
    TouchButton.Text = ""
    TouchButton.ZIndex = 2
    TouchButton.Parent = PlayerEntry
    
    TouchButton.MouseButton1Click:Connect(function()
        -- Deselect previous
        if SelectedPlayerButton and SelectedPlayerButton ~= PlayerEntry then
            SelectedPlayerButton.BackgroundColor3 = ColorPalette.BackgroundDark
            SelectedPlayerButton.BackgroundTransparency = 0.5
        end
        
        -- Select new
        SelectedPlayerButton = PlayerEntry
        SelectedPlayerButton.BackgroundColor3 = ColorPalette.Selected
        SelectedPlayerButton.BackgroundTransparency = 0.3
        
        CurrentTarget = player
        local displayName = PlayerNicknames[player.Name] or player.DisplayName
        SelectedValue.Text = displayName
        StatusValue.Text = "Ready to follow"
        
        -- Update button states
        UnfollowButton.BackgroundColor3 = ColorPalette.Danger
        FollowButton.BackgroundColor3 = ColorPalette.Primary
    end)
    
    return PlayerEntry
end

-- Update player list
local function updatePlayerList()
    PlayerListContainer:ClearAllChildren()
    
    for _, player in pairs(getAllPlayers()) do
        local playerEntry = createPlayerEntry(player)
        playerEntry.Parent = PlayerListContainer
    end
end

-- ===================== ADVANCED FOLLOW SYSTEM FUNCTIONS =====================

-- PHYSICS-AWARE ROOT DETECTION
local function findPhysicsRoot(character)
    if not character then return nil, false end
    
    local isVehicle = false
    
    -- Check for vehicle via humanoid seat
    local humanoid = character:FindFirstChildOfClass("Humanoid")
    if humanoid and humanoid.SeatPart then
        isVehicle = true
        local seat = humanoid.SeatPart
        
        -- Find the vehicle model
        local vehicleModel = seat.Parent
        if vehicleModel and vehicleModel:IsA("Model") then
            -- PRIMARY STRATEGY: Find AssemblyRootPart
            local assemblyRoot = vehicleModel:FindFirstChild("AssemblyRootPart")
            if assemblyRoot then
                return assemblyRoot, true, "AssemblyRoot"
            end
            
            -- SECONDARY: Use PrimaryPart if it's authoritative
            if vehicleModel.PrimaryPart then
                -- Check if PrimaryPart has physics authority
                if vehicleModel.PrimaryPart:GetNetworkOwner() == game.Players.LocalPlayer then
                    return vehicleModel.PrimaryPart, true, "PrimaryPart"
                end
                
                -- Find the part with most mass (likely main body)
                local maxMass = 0
                local heaviestPart = nil
                for _, part in pairs(vehicleModel:GetDescendants()) do
                    if part:IsA("BasePart") and part.Mass > maxMass then
                        maxMass = part.Mass
                        heaviestPart = part
                    end
                end
                if heaviestPart then
                    return heaviestPart, true, "HeaviestPart"
                end
            end
        end
        return seat, true, "VehicleSeat"
    end
    
    -- If not in vehicle, use humanoid root
    if character:FindFirstChild("HumanoidRootPart") then
        return character.HumanoidRootPart, false, "HumanoidRoot"
    end
    
    return character.PrimaryPart, false, "PrimaryPart"
end

-- AGGRESSIVE PHYSICS VALIDATION
local function validatePhysicsRoot(physicsRoot)
    if not physicsRoot then return false, "No root" end
    if not physicsRoot:IsDescendantOf(game) then return false, "Not in game" end
    
    -- Check for extreme movement (likely teleport or respawn)
    if LastRootCFrame then
        local delta = (physicsRoot.Position - LastRootCFrame.Position).Magnitude
        if delta > MAX_VALID_DELTA then
            return false, "Excessive delta: " .. math.floor(delta)
        end
    end
    
    -- Check for impossible speed
    local speed = physicsRoot.Velocity.Magnitude
    if speed > MAX_VALID_SPEED then
        return false, "Impossible speed: " .. math.floor(speed)
    end
    
    -- Check if part is likely decorative (small mass, welded to something else)
    if physicsRoot.Mass < 0.1 then
        return false, "Too light: " .. physicsRoot.Mass
    end
    
    return true, "Valid"
end

-- STABILITY CALCULATION FOR CLEAN LOCK
local function calculateStability(physicsRoot)
    local currentTime = tick()
    local currentPos = physicsRoot.Position
    local currentVel = physicsRoot.Velocity
    
    -- Add to history
    table.insert(SpeedHistory, 1, currentVel.Magnitude)
    table.insert(PhysicsStateHistory, 1, {
        position = currentPos,
        velocity = currentVel,
        time = currentTime
    })
    
    -- Trim history
    if #SpeedHistory > MAX_HISTORY then
        table.remove(SpeedHistory, MAX_HISTORY + 1)
    end
    if #PhysicsStateHistory > MAX_HISTORY then
        table.remove(PhysicsStateHistory, MAX_HISTORY + 1)
    end
    
    -- Calculate acceleration
    if #PhysicsStateHistory >= 2 then
        local deltaTime = PhysicsStateHistory[1].time - PhysicsStateHistory[2].time
        if deltaTime > 0 then
            local deltaVel = (PhysicsStateHistory[1].velocity - PhysicsStateHistory[2].velocity).Magnitude
            local acceleration = deltaVel / deltaTime
            table.insert(AccelerationHistory, 1, acceleration)
            
            -- Calculate jerk (change in acceleration)
            if #AccelerationHistory >= 2 then
                local jerk = math.abs(AccelerationHistory[1] - AccelerationHistory[2]) / deltaTime
                table.insert(JerkHistory, 1, jerk)
                if #JerkHistory > MAX_HISTORY then
                    table.remove(JerkHistory, MAX_HISTORY + 1)
                end
            end
        end
    end
    
    if #AccelerationHistory > MAX_HISTORY then
        table.remove(AccelerationHistory, MAX_HISTORY + 1)
    end
    
    -- Calculate stability score (0-100)
    local stability = 100
    
    -- Penalize for speed variance
    if #SpeedHistory >= 3 then
        local avgSpeed = 0
        for _, s in ipairs(SpeedHistory) do avgSpeed = avgSpeed + s end
        avgSpeed = avgSpeed / #SpeedHistory
        
        local variance = 0
        for _, s in ipairs(SpeedHistory) do
            variance = variance + (s - avgSpeed) ^ 2
        end
        variance = variance / #SpeedHistory
        
        stability = stability - math.min(variance * 10, 50)
    end
    
    -- Penalize for high jerk
    if #JerkHistory >= 2 then
        local maxJerk = 0
        for _, j in ipairs(JerkHistory) do
            if j > maxJerk then maxJerk = j end
        end
        stability = stability - math.min(maxJerk, 50)
    end
    
    stability = math.clamp(stability, 0, 100)
    StabilityScore = stability
    
    return stability
end

-- DETECT ASSEMBLY CHANGES
local function detectAssemblyChange(newRoot, isVehicle)
    if not PhysicsRoot then return true end -- First detection
    
    -- Different part instance
    if newRoot ~= PhysicsRoot then
        return true
    end
    
    -- Check if root lost parent (respawning, teleporting)
    if not newRoot:IsDescendantOf(game) then
        return true
    end
    
    -- Check for ownership change (network)
    local oldOwner = PhysicsRoot:GetNetworkOwner()
    local newOwner = newRoot:GetNetworkOwner()
    if oldOwner ~= newOwner then
        return true
    end
    
    -- Check for extreme position reset
    if LastRootCFrame then
        local delta = (newRoot.Position - LastRootCFrame.Position).Magnitude
        if delta > 50 then -- Large teleport
            return true
        end
    end
    
    return false
end

-- CLEAN LOCK INITIALIZATION
local function initializePhysicsLock(physicsRoot)
    -- Wait for stable frame if possible
    local startTime = tick()
    local maxWaitTime = 0.1 -- 100ms max wait
    
    while tick() - startTime < maxWaitTime do
        local stability = calculateStability(physicsRoot)
        if stability > 70 then -- Wait for decent stability
            break
        end
        RunService.Heartbeat:Wait()
    end
    
    -- Capture reference in local space
    local localCharacter = LocalPlayer.Character
    if not localCharacter then return false end
    
    local localRoot = localCharacter:FindFirstChild("HumanoidRootPart")
    if not localRoot then return false end
    
    -- Calculate offset in physics root's local space
    ReferenceOffset = physicsRoot.CFrame:PointToObjectSpace(localRoot.Position)
    PhysicsRoot = physicsRoot
    PhysicsRootId = tostring(physicsRoot:GetFullName())
    LastRootCFrame = physicsRoot.CFrame
    LastRootVelocity = physicsRoot.Velocity
    LastLockTime = tick()
    IsPhysicsLocked = true
    PhysicsFrameId = 0
    
    -- Clear history for fresh start
    SpeedHistory = {}
    AccelerationHistory = {}
    JerkHistory = {}
    PhysicsStateHistory = {}
    
    StatusValue.Text = "Physics Lock"
    
    return true
end

-- METHOD SELECTION WITH AGGRESSIVE LOCKING
local function selectBestMethod(physicsRoot, isVehicle, currentSpeed, stability)
    -- FORCE Physics Lock under extreme conditions
    if isVehicle and currentSpeed > 120 then
        return "Physics Lock"
    end
    
    if isVehicle and currentSpeed > 80 and stability < 30 then
        return "Physics Lock" -- Unstable fast vehicle
    end
    
    -- Velocity Match for moderate speeds
    if currentSpeed > 60 then
        return "Velocity Match"
    end
    
    -- Smart Follow for normal movement
    return "Smart Follow"
end

-- IMPROVED SMART FOLLOW WITH PREDICTION
local function smartFollowImproved(physicsRoot, isVehicle, currentSpeed)
    local localCharacter = LocalPlayer.Character
    if not localCharacter then return end
    
    local localRoot = localCharacter:FindFirstChild("HumanoidRootPart")
    if not localRoot then return end
    
    -- Calculate desired position with prediction
    local targetPos = physicsRoot.Position
    local targetVel = physicsRoot.Velocity
    
    -- Predict future position based on velocity
    local predictionTime = 0.1 -- 100ms lookahead
    local predictedPos = targetPos + (targetVel * predictionTime)
    
    -- Calculate offset
    local offset = Vector3.new(0, FollowHeight, -FollowDistance)
    if isVehicle then
        offset = Vector3.new(0, FollowHeight, -FollowDistance)
    else
        offset = Vector3.new(0, FollowHeight + 2, -FollowDistance)
    end
    
    -- Apply offset in world space
    local targetCFrame = physicsRoot.CFrame
    local worldOffset = targetCFrame:VectorToWorldSpace(offset)
    
    -- Blend between current and predicted position
    local desiredPos = (predictedPos * 0.3 + targetPos * 0.7) + worldOffset
    
    -- Move with adaptive speed
    local toTarget = desiredPos - localRoot.Position
    local distance = toTarget.Magnitude
    
    local moveSpeed = math.min(currentSpeed * 1.3, MaxFlySpeed)
    if distance > 10 then
        moveSpeed = moveSpeed * 2 -- Catch up faster
    end
    
    localRoot.Velocity = toTarget.Unit * moveSpeed
    
    -- Match rotation
    localRoot.CFrame = CFrame.new(localRoot.Position, physicsRoot.Position)
end

-- VELOCITY MATCH WITH ERROR CORRECTION
local function velocityMatchImproved(physicsRoot, isVehicle, currentSpeed)
    local localCharacter = LocalPlayer.Character
    if not localCharacter then return end
    
    local localRoot = localCharacter:FindFirstChild("HumanoidRootPart")
    if not localRoot then return end
    
    -- Match target velocity exactly
    local targetVel = physicsRoot.Velocity
    local targetCFrame = physicsRoot.CFrame
    
    -- Calculate desired position with offset
    local offset = Vector3.new(0, FollowHeight, -FollowDistance)
    if isVehicle then
        offset = Vector3.new(0, FollowHeight, -FollowDistance)
    else
        offset = Vector3.new(0, FollowHeight + 2, -FollowDistance)
    end
    
    local worldOffset = targetCFrame:VectorToWorldSpace(offset)
    local desiredPos = physicsRoot.Position + worldOffset
    
    -- Position correction
    local posError = desiredPos - localRoot.Position
    local errorMagnitude = posError.Magnitude
    
    -- Blend between velocity matching and position correction
    local correctionSpeed = math.min(errorMagnitude * 5, MaxFlySpeed)
    local correctionVec = posError.Unit * correctionSpeed
    
    local blendFactor = math.clamp(errorMagnitude / 10, 0, 1)
    localRoot.Velocity = targetVel * (1 - blendFactor) + correctionVec * blendFactor
    
    -- Match rotation
    localRoot.CFrame = CFrame.new(localRoot.Position, physicsRoot.Position)
end

-- ULTIMATE PHYSICS LOCK WITH VALIDATION
local function physicsLockUltimate(physicsRoot, isVehicle)
    local localCharacter = LocalPlayer.Character
    if not localCharacter then return end
    
    local localRoot = localCharacter:FindFirstChild("HumanoidRootPart")
    if not localRoot then return end
    
    PhysicsFrameId = PhysicsFrameId + 1
    
    -- AGGRESSIVE VALIDATION EVERY FRAME
    local isValid, reason = validatePhysicsRoot(physicsRoot)
    if not isValid then
        StatusValue.Text = "Validation Failed"
        IsPhysicsLocked = false
        return
    end
    
    -- DETECT ASSEMBLY CHANGE
    if detectAssemblyChange(physicsRoot, isVehicle) then
        StatusValue.Text = "Assembly Changed"
        IsPhysicsLocked = false
        AssemblyChangeDetected = true
        return
    end
    
    -- RE-INITIALIZE IF NEEDED
    if not IsPhysicsLocked or AssemblyChangeDetected then
        if tick() - LastLockTime > REBIND_COOLDOWN then
            if initializePhysicsLock(physicsRoot) then
                AssemblyChangeDetected = false
                StatusValue.Text = "Re-locked"
            else
                return
            end
        else
            return -- Still in cooldown
        end
    end
    
    -- SANITY CHECK: Ensure offset is valid
    if ReferenceOffset.Magnitude > 100 then
        ReferenceOffset = Vector3.new(0, FollowHeight, -FollowDistance)
    end
    
    -- CALCULATE NEW POSITION IN PHYSICS ROOT'S FRAME
    local currentCFrame = physicsRoot.CFrame
    local newPosition = currentCFrame:PointToWorldSpace(ReferenceOffset)
    
    -- VALIDATE POSITION CHANGE
    if LastRootCFrame then
        local delta = (currentCFrame.Position - LastRootCFrame.Position).Magnitude
        if delta > MAX_VALID_DELTA then
            StatusValue.Text = "Invalid Teleport"
            IsPhysicsLocked = false
            return
        end
    end
    
    -- APPLY POSITION IMMEDIATELY (NO VELOCITY, NO INTERPOLATION)
    localRoot.CFrame = CFrame.new(newPosition)
    localRoot.Velocity = Vector3.new(0, 0, 0) -- Zero out velocity
    
    -- UPDATE TRACKING
    LastRootCFrame = currentCFrame
    LastRootVelocity = physicsRoot.Velocity
end

-- MAIN HYBRID FOLLOW FUNCTION
local function hybridFollowUltimate()
    if not Following or not CurrentTarget or not CurrentTarget.Character then
        return
    end
    
    local targetCharacter = CurrentTarget.Character
    local localCharacter = LocalPlayer.Character
    
    if not localCharacter then return end
    
    -- Find physics root with aggressive validation
    local physicsRoot, isVehicle, rootType = findPhysicsRoot(targetCharacter)
    if not physicsRoot then
        StatusValue.Text = "No Physics Root"
        return
    end
    
    -- Validate root every frame
    local isValid, reason = validatePhysicsRoot(physicsRoot)
    if not isValid then
        StatusValue.Text = "Invalid Root"
        return
    end
    
    -- Calculate stability
    local stability = calculateStability(physicsRoot)
    local currentSpeed = physicsRoot.Velocity.Magnitude
    
    -- Select best method
    local newMethod = selectBestMethod(physicsRoot, isVehicle, currentSpeed, stability)
    if newMethod ~= Method then
        Method = newMethod
        
        -- Reset physics lock if switching away
        if Method ~= "Physics Lock" then
            IsPhysicsLocked = false
            PhysicsRoot = nil
        end
    end
    
    -- Execute method
    if Method == "Physics Lock" then
        physicsLockUltimate(physicsRoot, isVehicle)
    elseif Method == "Velocity Match" then
        velocityMatchImproved(physicsRoot, isVehicle, currentSpeed)
    else -- "Smart Follow"
        smartFollowImproved(physicsRoot, isVehicle, currentSpeed)
    end
end

-- TELEPORT WITH STABILITY CHECK
local function teleportToTarget()
    if not CurrentTarget or not CurrentTarget.Character then 
        return false
    end
    
    local targetCharacter = CurrentTarget.Character
    local localCharacter = LocalPlayer.Character
    
    if not localCharacter then return false end
    
    local physicsRoot = findPhysicsRoot(targetCharacter)
    if not physicsRoot then return false end
    
    local localRoot = localCharacter:FindFirstChild("HumanoidRootPart")
    if not localRoot then return false end
    
    -- Wait for stable frame if possible
    local attempts = 0
    while attempts < 10 and StabilityScore < 60 do
        calculateStability(physicsRoot)
        RunService.Heartbeat:Wait()
        attempts = attempts + 1
    end
    
    -- Teleport with offset
    local offset = Vector3.new(0, FollowHeight + 2, -FollowDistance)
    local worldOffset = physicsRoot.CFrame:VectorToWorldSpace(offset)
    localRoot.CFrame = CFrame.new(physicsRoot.Position + worldOffset)
    
    -- Reset tracking
    LastRootCFrame = physicsRoot.CFrame
    LastRootVelocity = physicsRoot.Velocity
    SpeedHistory = {}
    AccelerationHistory = {}
    JerkHistory = {}
    PhysicsStateHistory = {}
    
    StatusValue.Text = "Teleported"
    return true
end

-- ===================== GUI CONTROLS =====================

-- Mobile-friendly dragging
local function startDragging(input)
    if input.UserInputType == Enum.UserInputType.Touch or input.UserInputType == Enum.UserInputType.MouseButton1 then
        Dragging = true
        DragStartPosition = Vector2.new(input.Position.X, input.Position.Y)
        GuiStartPosition = Vector2.new(MainFrame.Position.X.Offset, MainFrame.Position.Y.Offset)
        
        TitleBar.BackgroundColor3 = ColorPalette.BackgroundDark
        
        local connection
        connection = RunService.Heartbeat:Connect(function()
            if Dragging then
                local input = UserInputService:GetMouseLocation()
                local delta = Vector2.new(input.X, input.Y) - DragStartPosition
                local newX = math.clamp(GuiStartPosition.X + delta.X, 0, workspace.CurrentCamera.ViewportSize.X - MainFrame.AbsoluteSize.X)
                local newY = math.clamp(GuiStartPosition.Y + delta.Y, 0, workspace.CurrentCamera.ViewportSize.Y - MainFrame.AbsoluteSize.Y)
                MainFrame.Position = UDim2.new(0, newX, 0, newY)
            else
                connection:Disconnect()
            end
        end)
    end
end

local function stopDragging(input)
    if input.UserInputType == Enum.UserInputType.Touch or input.UserInputType == Enum.UserInputType.MouseButton1 then
        Dragging = false
        TitleBar.BackgroundColor3 = ColorPalette.BackgroundLight
    end
end

-- Button press effect
local function buttonPressEffect(button)
    local originalColor = button.BackgroundColor3
    button.BackgroundColor3 = ColorPalette.ButtonPressed
    
    local connection
    connection = RunService.Heartbeat:Connect(function()
        if not button:IsMouseButtonPressed(Enum.UserInputType.MouseButton1) and 
           not button:IsMouseButtonPressed(Enum.UserInputType.Touch) then
            button.BackgroundColor3 = originalColor
            connection:Disconnect()
        end
    end)
end

-- Connect mobile events
TitleBar.InputBegan:Connect(startDragging)
TitleBar.InputEnded:Connect(stopDragging)

-- GUI Button events
CloseButton.MouseButton1Down:Connect(function() buttonPressEffect(CloseButton) end)
CloseButton.MouseButton1Click:Connect(function()
    ScreenGui:Destroy()
end)

-- Follow/Unfollow buttons
FollowButton.MouseButton1Down:Connect(function() buttonPressEffect(FollowButton) end)
FollowButton.MouseButton1Click:Connect(function()
    if CurrentTarget then
        if teleportToTarget() then
            Following = true
            Method = "Smart Follow"
            StatusValue.Text = "Following"
            FollowButton.BackgroundColor3 = ColorPalette.PrimaryDark
            UnfollowButton.BackgroundColor3 = ColorPalette.Danger
        end
    end
end)

TeleportButton.MouseButton1Down:Connect(function() buttonPressEffect(TeleportButton) end)
TeleportButton.MouseButton1Click:Connect(function()
    if CurrentTarget then
        teleportToTarget()
    end
end)

UnfollowButton.MouseButton1Down:Connect(function() buttonPressEffect(UnfollowButton) end)
UnfollowButton.MouseButton1Click:Connect(function()
    Following = false
    CurrentTarget = nil
    IsPhysicsLocked = false
    PhysicsRoot = nil
    AssemblyChangeDetected = false
    
    SelectedValue.Text = "None"
    StatusValue.Text = "Idle"
    SpeedValue.Text = tostring(MaxFlySpeed)
    FollowButton.BackgroundColor3 = ColorPalette.Success
    UnfollowButton.BackgroundColor3 = ColorPalette.ButtonNormal
    
    -- Deselect player in list
    if SelectedPlayerButton then
        SelectedPlayerButton.BackgroundColor3 = ColorPalette.BackgroundDark
        SelectedPlayerButton.BackgroundTransparency = 0.5
        SelectedPlayerButton = nil
    end
    
    -- Stop movement
    local character = LocalPlayer.Character
    if character and character:FindFirstChild("HumanoidRootPart") then
        character.HumanoidRootPart.Velocity = Vector3.new(0, 0, 0)
    end
end)

-- Speed adjustment
SpeedMinus.MouseButton1Click:Connect(function()
    MaxFlySpeed = math.clamp(MaxFlySpeed - 10, 10, 1000)
    SpeedValue.Text = tostring(MaxFlySpeed)
end)

SpeedPlus.MouseButton1Click:Connect(function()
    MaxFlySpeed = math.clamp(MaxFlySpeed + 10, 10, 1000)
    SpeedValue.Text = tostring(MaxFlySpeed)
end)

-- ===================== INITIALIZATION =====================

-- Initialize UI
SelectedValue.Text = "None"
StatusValue.Text = "Idle"
SpeedValue.Text = "300"

-- Initial player list
updatePlayerList()

-- Auto-refresh player list
Players.PlayerAdded:Connect(function(player)
    wait(0.5)
    updatePlayerList()
end)

Players.PlayerRemoving:Connect(function(player)
    updatePlayerList()
    if CurrentTarget == player then
        Following = false
        CurrentTarget = nil
        StatusValue.Text = "Target Left"
        SelectedValue.Text = "None"
        
        if SelectedPlayerButton then
            SelectedPlayerButton.BackgroundColor3 = ColorPalette.BackgroundDark
            SelectedPlayerButton.BackgroundTransparency = 0.5
            SelectedPlayerButton = nil
        end
    end
end)

-- Main follow loop
RunService.Heartbeat:Connect(function()
    if Following and CurrentTarget then
        if not CurrentTarget.Parent or not CurrentTarget.Character then
            Following = false
            StatusValue.Text = "Target Lost"
            return
        end
        
        hybridFollowUltimate()
    end
end)

-- Auto-refresh every 3 seconds
while true do
    wait(3)
    if not Following then
        updatePlayerList()
    end
end
